
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MinecraftåŒ…åŠ å¯†/è§£å¯†å·¥å…·</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<link rel="stylesheet" href="./main.css">
</head>
<body>
<!-- ç§»åŠ¨ç«¯è­¦å‘Šé®ç½© -->
<div class="mobile-warning-overlay" id="mobileWarning" style="display: none;">
<div class="mobile-warning-content">
    <div class="mobile-warning-icon">
        <i class="fas fa-mobile-alt"></i>
    </div>
    <h2>ç§»åŠ¨ç«¯ä¸æ”¯æŒ</h2>
    <p>æŠ±æ­‰ï¼Œæ­¤å·¥å…·éœ€è¦åœ¨æ¡Œé¢ç«¯æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œå› ä¸ºéœ€è¦å¤„ç†æ–‡ä»¶å¤¹å’Œå¤§é‡æ–‡ä»¶æ“ä½œã€‚</p>
    <div style="margin: 1.5rem 0;">
        <h3>ä¸ºä»€ä¹ˆä¸æ”¯æŒç§»åŠ¨ç«¯ï¼Ÿ</h3>
        <ul style="text-align: left; margin-top: 1rem;">
            <li><i class="fas fa-folder"></i> éœ€è¦æ–‡ä»¶å¤¹æ‹–æ‹½åŠŸèƒ½</li>
            <li><i class="fas fa-file-archive"></i> éœ€è¦å¤„ç†ZIPæ–‡ä»¶</li>
            <li><i class="fas fa-memory"></i> éœ€è¦å¤§é‡å†…å­˜å¤„ç†æ–‡ä»¶</li>
            <li><i class="fas fa-download"></i> éœ€è¦æ‰¹é‡ä¸‹è½½åŠŸèƒ½</li>
        </ul>
    </div>
    <button class="btn btn-primary" onclick="closeMobileWarning()">
        <i class="fas fa-times"></i>
        æˆ‘äº†è§£äº†
    </button>
</div>
</div>

<!-- Header -->
<div class="header">
<div class="header-content">
    <div class="brand">
        <div class="logo"><i class="fas fa-shield-alt"></i></div>
        <div class="brand-text">
            <h1>MinecraftåŒ…åŠ å¯†/è§£å¯†å·¥å…·</h1>
            <div class="brand-subtitle">æ™ºèƒ½ENTå¯†é’¥åŒ¹é…ï¼Œå®‰å…¨å¿«é€Ÿåœ°åŠ å¯†æˆ–è§£å¯†æ‚¨çš„Minecraftèµ„æºåŒ…å’Œè¡Œä¸ºåŒ…</div>
        </div>
        <div id="api-status" class="status-indicator status-offline">
            <i class="fas fa-circle"></i>
            æ£€æŸ¥ä¸­...
        </div>
    </div>
</div>
</div>

<!-- Main Content -->
<div class="main-container">
<!-- Content Area -->
<div class="content-area">
    <!-- Tab Navigation -->
    <div class="tab-container">
        <button class="tab-button active" onclick="switchTab('encrypt')">
            <i class="fas fa-lock"></i>
            åŠ å¯†åŒ…
        </button>
        <button class="tab-button" onclick="switchTab('decrypt')">
            <i class="fas fa-unlock"></i>
            è§£å¯†åŒ…
        </button>
        <button class="tab-button" onclick="switchTab('ent')">
            <i class="fas fa-key"></i>
            ENTè§£å¯†
        </button>
        <button class="tab-button" onclick="switchTab('options')">
            <i class="fas fa-cog"></i>
            Options.txt
        </button>
    </div>

    <!-- Encrypt Tab Content -->
    <div id="encrypt-tab" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-upload"></i>
                    é€‰æ‹©è¦åŠ å¯†çš„åŒ…æ–‡ä»¶
                </div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="encryptUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>æ‹–æ‹½æ–‡ä»¶å¤¹åˆ°è¿™é‡Œ</h3>
                    <p>æˆ–è€…ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('encryptFolderInput').click()">
                            <i class="fas fa-folder-open"></i>
                            é€‰æ‹©æ–‡ä»¶å¤¹
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('encryptFileInput').click()">
                            <i class="fas fa-file-archive"></i>
                            é€‰æ‹©ZIPæ–‡ä»¶
                        </button>
                    </div>
                    <input type="file" id="encryptFolderInput" webkitdirectory multiple style="display: none;">
                    <input type="file" id="encryptFileInput" accept=".zip,.mcpack" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Decrypt Tab Content -->
    <div id="decrypt-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-upload"></i>
                    é€‰æ‹©è¦è§£å¯†çš„åŒ…æ–‡ä»¶
                </div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="decryptUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>æ‹–æ‹½åŠ å¯†åŒ…åˆ°è¿™é‡Œ</h3>
                    <p>ç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é…æœ€ä½³å¯†é’¥è¿›è¡Œè§£å¯†</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('decryptFolderInput').click()">
                            <i class="fas fa-folder-open"></i>
                            é€‰æ‹©æ–‡ä»¶å¤¹
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('decryptFileInput').click()">
                            <i class="fas fa-file-archive"></i>
                            é€‰æ‹©ZIPæ–‡ä»¶
                        </button>
                    </div>
                    <input type="file" id="decryptFolderInput" webkitdirectory multiple style="display: none;">
                    <input type="file" id="decryptFileInput" accept=".zip,.mcpack" style="display: none;">
                </div>
                
                <!-- å¯†é’¥æ•°æ®åº“çŠ¶æ€ -->
                <div class="form-group" style="margin-top: 2rem;">
                    <label class="label">
                        <i class="fas fa-database"></i>
                        å¯†é’¥æ•°æ®åº“çŠ¶æ€
                    </label>
                    <div class="key-database-status" id="keyDatabaseStatus">
                        <div class="status-item">
                            <span class="status-label">ENTå¯†é’¥æ•°é‡</span>
                            <span class="status-value" id="dbKeyCount">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">åŒ¹é…ç®—æ³•</span>
                            <span class="status-value">UUIDæ™ºèƒ½åŒ¹é…</span>
                        </div>
                    </div>
                    <small class="text-secondary">
                        ğŸ’¡ å»ºè®®å…ˆè§£å¯†ENTæ–‡ä»¶å»ºç«‹å¯†é’¥åº“ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é…æ­£ç¡®çš„å¯†é’¥
                    </small>
                </div>
                
                <!-- ENTæˆæƒæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="label">
                        <i class="fas fa-key"></i>
                        å¿«é€ŸENTå¯†é’¥å¯¼å…¥
                    </label>
                    <div class="upload-zone" id="decryptEntUploadZone" style="padding: 1.5rem; border-style: dashed;">
                        <div class="upload-icon" style="font-size: 2rem; margin-bottom: 1rem;">
                            <i class="fas fa-file-code"></i>
                        </div>
                        <h4>ç›´æ¥æ‹–æ‹½ENTæ–‡ä»¶å¿«é€Ÿå¯¼å…¥å¯†é’¥</h4>
                        <p style="margin-bottom: 1rem;">ENTå¯†é’¥ä¼šè‡ªåŠ¨ä¿å­˜åˆ°å¯†é’¥åº“ï¼Œè§£å¯†æ—¶è‡ªåŠ¨åŒ¹é…</p>
                        <button class="btn btn-outline" onclick="document.getElementById('decryptEntInput').click()">
                            <i class="fas fa-file-upload"></i>
                            é€‰æ‹©ENTæ–‡ä»¶
                        </button>
                        <input type="file" id="decryptEntInput" accept=".ent" style="display: none;">
                    </div>
                </div>
                
                <!-- Minecraftè´¦æˆ·ID -->
                <div class="form-group" style="margin-top: 1rem;">
                    <label class="label">Minecraftè´¦æˆ·ID (ENTè§£å¯†ç”¨)</label>
                    <input type="text" class="input" id="decryptMinecraftId" placeholder="å¦‚æœENTæ–‡ä»¶åŠ å¯†ï¼Œéœ€è¦è¾“å…¥è´¦æˆ·ID">
                    <small class="text-secondary">é€šå¸¸åœ¨æ¸¸æˆè®¾ç½®æˆ–options.txtä¸­æ‰¾åˆ°</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ENT Decrypt Tab Content -->
    <div id="ent-tab" class="tab-content">
        <div class="card ent-info-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-key"></i>
                    ENTæˆæƒæ–‡ä»¶è§£å¯†
                </div>
                <div style="margin-left: auto;">
                    <span class="badge badge-info">
                        <i class="fas fa-info-circle"></i>
                        è‡ªåŠ¨å»ºç«‹å¯†é’¥åº“
                    </span>
                </div>
            </div>
            <div class="card-content">
                <div class="ent-workflow-info" style="margin-bottom: 2rem; padding: 1.5rem; background: var(--info-bg); border-radius: var(--radius); border: 1px solid var(--info);">
                    <h3 style="margin-bottom: 1rem; color: var(--info);">
                        <i class="fas fa-lightbulb"></i>
                        æ™ºèƒ½å¯†é’¥åŒ¹é…å·¥ä½œæµç¨‹
                    </h3>
                    <div class="workflow-steps">
                        <div class="workflow-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <strong>è§£å¯†ENTæ–‡ä»¶</strong>
                                <p>æå–æ‰€æœ‰åŒ…å¯†é’¥å¹¶è‡ªåŠ¨ä¿å­˜åˆ°å¯†é’¥æ•°æ®åº“</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <strong>è§£å¯†åŠ å¯†åŒ…</strong>
                                <p>ç³»ç»Ÿè‡ªåŠ¨è¯»å–åŒ…UUIDï¼ŒåŒ¹é…æ­£ç¡®å¯†é’¥è¿›è¡Œè§£å¯†</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <strong>ä¸€é”®è§£å¯†æˆåŠŸ</strong>
                                <p>æ— éœ€æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼Œå…¨è‡ªåŠ¨æ™ºèƒ½åŒ¹é…</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="upload-zone" id="entUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <h3>ä¸Šä¼ ENTæˆæƒæ–‡ä»¶</h3>
                    <p>æ”¯æŒåŠ å¯†å’ŒæœªåŠ å¯†çš„.entæ–‡ä»¶ï¼Œå°†è‡ªåŠ¨æå–å¹¶ä¿å­˜æ‰€æœ‰å¯†é’¥</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('entFileInput').click()">
                            <i class="fas fa-file-upload"></i>
                            é€‰æ‹©ENTæ–‡ä»¶
                        </button>
                    </div>
                    <input type="file" id="entFileInput" accept=".ent" style="display: none;">
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="label">Minecraftè´¦æˆ·ID (å¯é€‰)</label>
                    <input type="text" class="input" id="minecraftId" placeholder="ç”¨äºè§£å¯†åŠ å¯†çš„ENTæ–‡ä»¶">
                    <small class="text-secondary">é€šå¸¸åœ¨æ¸¸æˆè®¾ç½®æˆ–options.txtä¸­æ‰¾åˆ°ï¼Œå¦‚æœENTæ–‡ä»¶æ˜¯åŠ å¯†çš„ï¼Œéœ€è¦æ­¤ä¿¡æ¯</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Options.txt Tab Content -->
    <div id="options-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-cog"></i>
                    Options.txt é…ç½®æ–‡ä»¶
                </div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="optionsUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-file-text"></i>
                    </div>
                    <h3>ä¸Šä¼ Options.txtæ–‡ä»¶</h3>
                    <p>ä»Minecrafté…ç½®æ–‡ä»¶ä¸­æå–è´¦æˆ·ä¿¡æ¯ç”¨äºENTè§£å¯†</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('optionsFileInput').click()">
                            <i class="fas fa-file-upload"></i>
                            é€‰æ‹©Options.txt
                        </button>
                    </div>
                    <input type="file" id="optionsFileInput" accept=".txt" style="display: none;">
                </div>
                
                <div class="options-info" id="optionsInfo" style="display: none;">
                    <h4 style="margin-bottom: 0.5rem;">
                        <i class="fas fa-info-circle"></i>
                        é…ç½®æ–‡ä»¶ä¿¡æ¯
                    </h4>
                    <div id="optionsDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- File List Section -->
    <div class="card" id="fileListSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-list"></i>
                å·²é€‰æ‹©çš„æ–‡ä»¶
            </div>
            <span class="badge badge-success">
                <span id="fileCount">0</span> ä¸ªæ–‡ä»¶
            </span>
        </div>
        <div class="card-content">
            <div class="file-list" id="fileList"></div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="card" id="progressSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-spinner fa-spin"></i>
                å¤„ç†è¿›åº¦
            </div>
            <span id="progressText">å‡†å¤‡ä¸­...</span>
        </div>
        <div class="card-content">
            <div class="progress">
                <div class="progress-bar" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="card" id="resultsSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-chart-bar"></i>
                <span id="resultTitle">å¤„ç†ç»“æœ</span>
            </div>
            <div id="keyMatchingStatus" class="key-matching-indicator" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="keyMatchingText">æ™ºèƒ½åŒ¹é…æˆåŠŸ</span>
            </div>
        </div>
        <div class="card-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <div class="stat-value" id="processedFiles">0</div>
                    <div class="stat-label" id="processedLabel">å¤„ç†æ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-files"></i>
                    </div>
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div class="stat-value" id="packageName">-</div>
                    <div class="stat-label">åŒ…åç§°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="stat-value" id="operationKey">-</div>
                    <div class="stat-label" id="keyLabel">ä½¿ç”¨å¯†é’¥</div>
                </div>
            </div>
            <div id="packDetailsInfo" class="pack-info" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- ENT Results Section -->
    <div class="card" id="entResultsSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-key"></i>
                å¯†é’¥å·²ä¿å­˜åˆ°æ•°æ®åº“
            </div>
            <span class="badge badge-success">
                <span id="keyCount">0</span> ä¸ªå¯†é’¥
            </span>
        </div>
        <div class="card-content">
            <div class="database-save-notice" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius);">
                <h4 style="margin-bottom: 0.5rem; color: var(--success);">
                    <i class="fas fa-database"></i>
                    å¯†é’¥å·²è‡ªåŠ¨ä¿å­˜
                </h4>
                <p style="margin: 0; color: var(--success);">
                    æ‰€æœ‰æå–çš„å¯†é’¥å·²ä¿å­˜åˆ°å¯†é’¥æ•°æ®åº“ã€‚ç°åœ¨æ‚¨å¯ä»¥ç›´æ¥ä¸Šä¼ åŠ å¯†åŒ…è¿›è¡Œè§£å¯†ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é…æ­£ç¡®çš„å¯†é’¥ã€‚
                </p>
            </div>
            <div id="entResultInfo" class="pack-info" style="margin-bottom: 1rem;"></div>
            <div class="key-list" id="keyList"></div>
        </div>
    </div>
</div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Settings Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-cog"></i>
                        è®¾ç½®
                    </div>
                </div>
                <div class="card-content">
                    <!-- åŠ å¯†æ¨¡å¼ï¼šè‡ªå®šä¹‰å¯†é’¥ -->
                    <div class="form-group" id="customKeyGroup">
                        <label class="label">è‡ªå®šä¹‰å¯†é’¥ (å¯é€‰)</label>
                        <input type="text" class="input" id="customKey" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                        <small class="text-secondary">32å­—ç¬¦çš„å­—æ¯æ•°å­—ç»„åˆ</small>
                        <button class="btn btn-outline btn-full" onclick="generateKey()">
                            <i class="fas fa-random"></i>
                            ç”Ÿæˆéšæœºå¯†é’¥
                        </button>
                    </div>
                    
                    <!-- è§£å¯†æ¨¡å¼ï¼šæ™ºèƒ½åŒ¹é…è®¾ç½® -->
                    <div class="form-group hidden" id="decryptSmartGroup">
                        <label class="label">
                            <i class="fas fa-magic"></i>
                            æ™ºèƒ½è§£å¯†è®¾ç½®
                        </label>
                        
                        <div class="smart-decrypt-info" style="margin: 1rem 0; padding: 1rem; background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text);">
                                <i class="fas fa-brain"></i>
                                å¯†é’¥é€‰æ‹©ä¼˜å…ˆçº§
                            </h4>
                            <div class="priority-list">
                                <div class="priority-item">
                                    <span class="priority-number">1</span>
                                    <span class="priority-text">ç”¨æˆ·è‡ªå®šä¹‰å¯†é’¥</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-number">2</span>
                                    <span class="priority-text">UUIDåŒ¹é…å¯†é’¥</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-number">3</span>
                                    <span class="priority-text">é»˜è®¤çš®è‚¤å¯†é’¥</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="label">æ‰‹åŠ¨å¯†é’¥è¦†ç›– (é«˜çº§)</label>
                            <input type="text" class="input" id="manualDecryptKey" placeholder="ç•™ç©ºä½¿ç”¨æ™ºèƒ½åŒ¹é…">
                            <small class="text-secondary">ä»…åœ¨æ™ºèƒ½åŒ¹é…å¤±è´¥æ—¶æ‰‹åŠ¨æŒ‡å®š</small>
                        </div>
                        
                        <!-- å¯†é’¥åº“çŠ¶æ€ -->
                        <div class="key-library-status" style="margin-top: 1rem;">
                            <div class="status-header">
                                <i class="fas fa-database"></i>
                                å¯†é’¥åº“çŠ¶æ€
                            </div>
                            <div class="status-content" id="keyLibraryContent">
                                <div class="status-row">
                                    <span>ENTå¯†é’¥æ•°é‡</span>
                                    <span id="sidebarKeyCount">0</span>
                                </div>
                                <div class="status-row">
                                    <span>æ•°æ®åº“çŠ¶æ€</span>
                                    <span id="dbStatus">ç©º</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group hidden" id="entOptionsGroup">
                        <label class="label">è¾“å‡ºæ ¼å¼</label>
                        <select class="input" id="entOutputFormat">
                            <option value="json">JSONæ ¼å¼</option>
                            <option value="keys_db">Keys.dbæ ¼å¼</option>
                            <option value="both">ä¸¤ç§æ ¼å¼</option>
                        </select>
                        <small class="text-secondary">é€‰æ‹©å¯†é’¥å¯¼å‡ºæ ¼å¼</small>
                    </div>

                    <div class="form-group hidden" id="optionsGroup">
                        <label class="label">è´¦æˆ·ä¿¡æ¯</label>
                        <div id="accountInfo" class="options-preview" style="max-height: 150px;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                è¯·å…ˆä¸Šä¼ options.txtæ–‡ä»¶
                            </div>
                        </div>
                        <button class="btn btn-outline btn-full" id="useOptionsBtn" onclick="useOptionsForEnt()" disabled>
                            <i class="fas fa-arrow-right"></i>
                            ç”¨äºENTè§£å¯†
                        </button>
                    </div>
                </div>
            </div>

    <!-- Key Database Management -->
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-database"></i>
                å¯†é’¥åº“ç®¡ç†
            </div>
            <span class="badge badge-info">
                <span id="keyLibraryCount">0</span> ä¸ªå¯†é’¥
            </span>
        </div>
        <div class="card-content">
            <div class="key-management-buttons">
                <button class="btn btn-outline btn-half" onclick="exportKeyDatabase()">
                    <i class="fas fa-download"></i>
                    å¯¼å‡ºå¯†é’¥åº“
                </button>
                <button class="btn btn-outline btn-half" onclick="document.getElementById('importKeyInput').click()">
                    <i class="fas fa-upload"></i>
                    å¯¼å…¥å¯†é’¥åº“
                </button>
                <input type="file" id="importKeyInput" accept=".json" style="display: none;" onchange="importKeyDatabase(event)">
            </div>
            <div class="key-database-summary" id="keyDatabaseSummary">
                <div class="summary-item">
                    <span class="summary-label">æ€»å¯†é’¥æ•°</span>
                    <span class="summary-value" id="totalKeysCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æœ€åæ›´æ–°</span>
                    <span class="summary-value" id="lastUpdateTime">ä»æœª</span>
                </div>
            </div>
            <div class="key-database-actions">
                <button class="btn btn-danger btn-small" onclick="clearKeyDatabase()">
                    <i class="fas fa-trash"></i>
                    æ¸…ç©ºå¯†é’¥åº“
                </button>
                <button class="btn btn-info btn-small" onclick="viewKeyDatabase()">
                    <i class="fas fa-eye"></i>
                    æŸ¥çœ‹å¯†é’¥
                </button>
            </div>
        </div>
    </div>

    <!-- Action Area -->
    <div class="action-area">
        <button class="btn btn-primary btn-lg btn-full" id="processBtn" onclick="processFiles()" disabled>
            <i class="fas fa-lock"></i>
            <span id="processBtnText">å¼€å§‹åŠ è§£å¯†</span>
        </button>
        <button class="btn btn-success btn-lg btn-full hidden" id="downloadBtn" onclick="downloadResult()">
            <i class="fas fa-download"></i>
            ä¸‹è½½ç»“æœ
        </button>
        <button class="btn btn-warning btn-full" onclick="cleanupFiles()">
            <i class="fas fa-trash"></i>
            æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        </button>
    </div>
</div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// API åŸºç¡€URL
const API_BASE = 'https://www.menthamc.club:5000';

let selectedFiles = [];
let extractedFiles = [];
let currentDownloadFilename = null;
let currentMode = 'encrypt'; // 'encrypt', 'decrypt', 'ent', or 'options'
let isProcessingZip = false;
let optionsData = null; // å­˜å‚¨options.txtæ•°æ®
let entKeys = []; // å­˜å‚¨ENTè§£æå‡ºçš„å¯†é’¥
let keyDatabaseCount = 0; // å¯†é’¥æ•°æ®åº“ä¸­çš„å¯†é’¥æ•°é‡

// å¯†é’¥åº“ç®¡ç†
let keyDatabase = {
    keys: {}, // uuid -> key æ˜ å°„
    metadata: {
        totalKeys: 0,
        lastUpdate: null,
        version: '1.0'
    }
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    setupFileUpload();
    checkApiStatus();
    checkMobileDevice();
    updateKeyDatabaseStatus(); // æ›´æ–°å¯†é’¥åº“çŠ¶æ€
    switchTab('encrypt'); // é»˜è®¤åŠ å¯†æ¨¡å¼
});

// æ£€æŸ¥ç§»åŠ¨è®¾å¤‡
function checkMobileDevice() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.getElementById('mobileWarning').style.display = 'flex';
    }
}

function closeMobileWarning() {
    document.getElementById('mobileWarning').style.display = 'none';
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(mode) {
    currentMode = mode;
    
    // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-button[onclick="switchTab('${mode}')"]`).classList.add('active');
    
    // æ›´æ–°å†…å®¹æ˜¾ç¤º
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`${mode}-tab`).classList.add('active');
    
    // æ˜¾ç¤º/éšè—è®¾ç½®ç»„
    document.getElementById('customKeyGroup').style.display = 
        mode === 'encrypt' ? 'block' : 'none';
    document.getElementById('decryptSmartGroup').style.display = 
        mode === 'decrypt' ? 'block' : 'none';
    document.getElementById('entOptionsGroup').style.display = 
        mode === 'ent' ? 'block' : 'none';
    document.getElementById('optionsGroup').style.display = 
        mode === 'options' ? 'block' : 'none';
    
    // æ›´æ–°UIæ–‡æœ¬
    if (mode === 'encrypt') {
        document.getElementById('processBtnText').textContent = 'å¼€å§‹åŠ å¯†';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-lock"></i> å¼€å§‹åŠ å¯†';
        document.getElementById('customKey').placeholder = 'ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ';
    } else if (mode === 'decrypt') {
        document.getElementById('processBtnText').textContent = 'æ™ºèƒ½è§£å¯†';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-magic"></i> æ™ºèƒ½è§£å¯†';
        document.getElementById('manualDecryptKey').placeholder = 'ç•™ç©ºä½¿ç”¨æ™ºèƒ½åŒ¹é…';
    } else if (mode === 'ent') {
        document.getElementById('processBtnText').textContent = 'è§£æENTæ–‡ä»¶';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-key"></i> è§£æENTæ–‡ä»¶';
    } else if (mode === 'options') {
        document.getElementById('processBtnText').textContent = 'è§£æOptions.txt';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-cog"></i> è§£æOptions.txt';
    }
    
    // é‡ç½®æ–‡ä»¶é€‰æ‹©
    selectedFiles = [];
    extractedFiles = [];
    
    updateProcessButton();
    
    // åªåœ¨åˆ‡æ¢åˆ°éOptionsæ¨¡å¼æ—¶éšè—ç»“æœ
    if (mode !== 'options') {
        hideResults();
    }
}

// æ›´æ–°å¯†é’¥æ•°æ®åº“çŠ¶æ€
function updateKeyDatabaseStatus() {
    const dbKeyCountEl = document.getElementById('dbKeyCount');
    const sidebarKeyCountEl = document.getElementById('sidebarKeyCount');
    const dbStatusEl = document.getElementById('dbStatus');
    const keyLibraryCountEl = document.getElementById('keyLibraryCount');
    const totalKeysCountEl = document.getElementById('totalKeysCount');
    const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
    
    const totalKeys = keyDatabase.metadata.totalKeys;
    
    if (dbKeyCountEl) {
        dbKeyCountEl.textContent = totalKeys;
    }
    if (sidebarKeyCountEl) {
        sidebarKeyCountEl.textContent = totalKeys;
    }
    if (dbStatusEl) {
        dbStatusEl.textContent = totalKeys > 0 ? 'æ´»è·ƒ' : 'ç©º';
    }
    if (keyLibraryCountEl) {
        keyLibraryCountEl.textContent = totalKeys;
    }
    if (totalKeysCountEl) {
        totalKeysCountEl.textContent = totalKeys;
    }
    if (lastUpdateTimeEl) {
        if (keyDatabase.metadata.lastUpdate) {
            const updateTime = new Date(keyDatabase.metadata.lastUpdate);
            lastUpdateTimeEl.textContent = updateTime.toLocaleString();
        } else {
            lastUpdateTimeEl.textContent = 'ä»æœª';
        }
    }
}

// æ·»åŠ å¯†é’¥åˆ°æ•°æ®åº“
function addKeysToDatabase(keys) {
    if (!keys || keys.length === 0) return;
    
    let addedCount = 0;
    keys.forEach(key => {
        const uuid = key.id || key.uuid;
        const contentKey = key.contentKey || key.content_key;
        
        if (uuid && contentKey) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (!keyDatabase.keys[uuid]) {
                keyDatabase.keys[uuid] = {
                    uuid: uuid,
                    key: contentKey,
                    addedTime: new Date().toISOString(),
                    source: 'ENT'
                };
                addedCount++;
            }
        }
    });
    
    keyDatabase.metadata.totalKeys = Object.keys(keyDatabase.keys).length;
    keyDatabase.metadata.lastUpdate = new Date().toISOString();
    
    updateKeyDatabaseStatus();
    
    if (addedCount > 0) {
        showToast(`æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªæ–°å¯†é’¥åˆ°å¯†é’¥åº“`, 'success');
    }
}

// å¯¼å‡ºå¯†é’¥åº“
function exportKeyDatabase() {
    try {
        if (keyDatabase.metadata.totalKeys === 0) {
            showToast('å¯†é’¥åº“ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'warning');
            return;
        }
        
        const exportData = {
            ...keyDatabase,
            exportTime: new Date().toISOString(),
            exportVersion: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `minecraft_key_database_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(link.href);
        
        showToast(`æˆåŠŸå¯¼å‡º ${keyDatabase.metadata.totalKeys} ä¸ªå¯†é’¥`, 'success');
        
    } catch (error) {
        showToast('å¯¼å‡ºå¯†é’¥åº“å¤±è´¥: ' + error.message, 'error');
    }
}

// å¯¼å…¥å¯†é’¥åº“
async function importKeyDatabase(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        const text = await file.text();
        const importData = JSON.parse(text);
        
        // éªŒè¯å¯¼å…¥æ•°æ®æ ¼å¼
        if (!importData.keys || !importData.metadata) {
            throw new Error('æ— æ•ˆçš„å¯†é’¥åº“æ–‡ä»¶æ ¼å¼');
        }
        
        // åˆå¹¶å¯†é’¥ï¼ˆé¿å…è¦†ç›–ç°æœ‰å¯†é’¥ï¼‰
        let importedCount = 0;
        let updatedCount = 0;
        
        Object.keys(importData.keys).forEach(uuid => {
            const importKey = importData.keys[uuid];
            if (keyDatabase.keys[uuid]) {
                // æ›´æ–°ç°æœ‰å¯†é’¥
                keyDatabase.keys[uuid] = {
                    ...keyDatabase.keys[uuid],
                    ...importKey,
                    updatedTime: new Date().toISOString()
                };
                updatedCount++;
            } else {
                // æ·»åŠ æ–°å¯†é’¥
                keyDatabase.keys[uuid] = {
                    ...importKey,
                    importedTime: new Date().toISOString()
                };
                importedCount++;
            }
        });
        
        // æ›´æ–°å…ƒæ•°æ®
        keyDatabase.metadata.totalKeys = Object.keys(keyDatabase.keys).length;
        keyDatabase.metadata.lastUpdate = new Date().toISOString();
        
        updateKeyDatabaseStatus();
        
        showToast(`å¯¼å…¥å®Œæˆï¼æ–°å¢ ${importedCount} ä¸ªå¯†é’¥ï¼Œæ›´æ–° ${updatedCount} ä¸ªå¯†é’¥`, 'success');
        
    } catch (error) {
        showToast('å¯¼å…¥å¯†é’¥åº“å¤±è´¥: ' + error.message, 'error');
    }
    
    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
    event.target.value = '';
}

// æ¸…ç©ºå¯†é’¥åº“
function clearKeyDatabase() {
    if (keyDatabase.metadata.totalKeys === 0) {
        showToast('å¯†é’¥åº“å·²ç»ä¸ºç©º', 'info');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦æ¸…ç©ºå¯†é’¥åº“å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ ${keyDatabase.metadata.totalKeys} ä¸ªå¯†é’¥ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) {
        keyDatabase.keys = {};
        keyDatabase.metadata.totalKeys = 0;
        keyDatabase.metadata.lastUpdate = new Date().toISOString();
        
        updateKeyDatabaseStatus();
        showToast('å¯†é’¥åº“å·²æ¸…ç©º', 'info');
    }
}

// æŸ¥çœ‹å¯†é’¥åº“
function viewKeyDatabase() {
    if (keyDatabase.metadata.totalKeys === 0) {
        showToast('å¯†é’¥åº“ä¸ºç©º', 'info');
        return;
    }
    
    // åˆ›å»ºæ¨¡æ€çª—å£æ˜¾ç¤ºå¯†é’¥åº“å†…å®¹
    const modal = document.createElement('div');
    modal.className = 'key-database-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: var(--bg);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    `;
    
    let keysHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="margin: 0; color: var(--text);">
                <i class="fas fa-database"></i>
                å¯†é’¥åº“å†…å®¹ (${keyDatabase.metadata.totalKeys} ä¸ªå¯†é’¥)
            </h2>
            <button onclick="this.closest('.key-database-modal').remove()" style="background: var(--error); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); cursor: pointer;">
                <i class="fas fa-times"></i>
                å…³é—­
            </button>
        </div>
        <div style="display: grid; gap: 1rem;">
    `;
    
    Object.keys(keyDatabase.keys).forEach(uuid => {
        const keyData = keyDatabase.keys[uuid];
        keysHTML += `
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <div style="font-family: monospace; font-weight: bold; color: var(--text); margin-bottom: 0.5rem;">
                    UUID: ${uuid}
                </div>
                <div style="font-family: monospace; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    å¯†é’¥: ${keyData.key}
                </div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                    æ¥æº: ${keyData.source || 'æœªçŸ¥'} | 
                    æ·»åŠ æ—¶é—´: ${keyData.addedTime ? new Date(keyData.addedTime).toLocaleString() : 'æœªçŸ¥'}
                    <button onclick="copyToClipboard('${keyData.key}', this)" style="margin-left: 1rem; background: var(--info); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-copy"></i> å¤åˆ¶
                    </button>
                </div>
            </div>
        `;
    });
    
    keysHTML += '</div>';
    modalContent.innerHTML = keysHTML;
    modal.appendChild(modalContent);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€çª—å£
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

// å¤„ç†è§£å¯†æ¨¡å¼ä¸‹çš„ENTæ–‡ä»¶
async function processDecryptEntFile(file) {
    try {
        showToast('æ­£åœ¨è§£æENTæ–‡ä»¶å¹¶ä¿å­˜å¯†é’¥...', 'info');
        
        // è·å–Minecraft ID
        const minecraftId = document.getElementById('decryptMinecraftId').value.trim();
        
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('ent_file', file);
        
        if (minecraftId) {
            formData.append('minecraft_id', minecraftId);
        }
        
        formData.append('output_format', 'json');

        // å‘é€è¯·æ±‚è§£æENT
        const response = await fetch(`${API_BASE}/api/decrypt-ent`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // ä¿å­˜å¯†é’¥æ•°æ®
            entKeys = data.keys || [];
            
            // æ·»åŠ å¯†é’¥åˆ°æœ¬åœ°æ•°æ®åº“
            addKeysToDatabase(entKeys);
            
            showToast(`ENTæ–‡ä»¶è§£ææˆåŠŸï¼å·²å‘å¯†é’¥åº“æ·»åŠ å¯†é’¥`, 'success');
        } else {
            throw new Error(data.error || 'ENTè§£æå¤±è´¥');
        }
        
    } catch (error) {
        showToast('ENTæ–‡ä»¶è§£æå¤±è´¥: ' + error.message, 'error');
    }
}

// æ–‡ä»¶ä¸Šä¼ è®¾ç½®
function setupFileUpload() {
    // åŠ å¯†æ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 
    setupUploadZone('encryptUploadZone', ['encryptFolderInput', 'encryptFileInput']);
    // è§£å¯†æ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 
    setupUploadZone('decryptUploadZone', ['decryptFolderInput', 'decryptFileInput']);
    // è§£å¯†æ¨¡å¼çš„ENTæ–‡ä»¶ä¸Šä¼ 
    setupUploadZone('decryptEntUploadZone', ['decryptEntInput']);
    // ENTæ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 
    setupUploadZone('entUploadZone', ['entFileInput']);
    // Optionsæ¨¡å¼çš„æ–‡ä»¶ä¸Šä¼ 
    setupUploadZone('optionsUploadZone', ['optionsFileInput']);
}

function setupUploadZone(zoneId, inputIds) {
    const uploadZone = document.getElementById(zoneId);
    const inputs = inputIds.map(id => document.getElementById(id));

    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    inputs.forEach(input => {
        input.addEventListener('change', handleFileSelect);
    });

    // æ‹–æ‹½åŠŸèƒ½
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            handleDroppedFiles(files);
        }
    });
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
async function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è§£å¯†æ¨¡å¼çš„ENTæ–‡ä»¶ä¸Šä¼ 
    if (event.target.id === 'decryptEntInput') {
        if (files.length > 0) {
            await processDecryptEntFile(files[0]);
        }
        return;
    }
    
    if (currentMode === 'ent') {
        // ENTæ¨¡å¼åªå¤„ç†å•ä¸ªæ–‡ä»¶
        if (files.length > 0) {
            selectedFiles = [files[0]];
            displayEntFile(files[0]);
            updateProcessButton();
        }
    } else if (currentMode === 'options') {
        // Optionsæ¨¡å¼åªå¤„ç†å•ä¸ªæ–‡ä»¶
        if (files.length > 0) {
            selectedFiles = [files[0]];
            await processOptionsFile(files[0]);
            updateProcessButton();
        }
    } else {
        await processSelectedFiles(files);
    }
}

// å¤„ç†æ‹–æ‹½æ–‡ä»¶
async function handleDroppedFiles(files) {
    if (currentMode === 'ent') {
        // ENTæ¨¡å¼åªå¤„ç†å•ä¸ªæ–‡ä»¶
        const entFile = files.find(file => file.name.toLowerCase().endsWith('.ent'));
        if (entFile) {
            selectedFiles = [entFile];
            displayEntFile(entFile);
            updateProcessButton();
        } else {
            showToast('è¯·é€‰æ‹©.entæ–‡ä»¶', 'error');
        }
    } else if (currentMode === 'options') {
        // Optionsæ¨¡å¼åªå¤„ç†å•ä¸ªæ–‡ä»¶
        const txtFile = files.find(file => 
            file.name.toLowerCase().endsWith('.txt') && 
            file.name.toLowerCase().includes('options')
        );
        if (txtFile) {
            selectedFiles = [txtFile];
            await processOptionsFile(txtFile);
            updateProcessButton();
        } else {
            showToast('è¯·é€‰æ‹©options.txtæ–‡ä»¶', 'error');
        }
    } else {
        await processSelectedFiles(files);
    }
}

// å¤„ç†Options.txtæ–‡ä»¶
async function processOptionsFile(file) {
    try {
        // å…ˆä½¿ç”¨åç«¯APIè§£æ
        const formData = new FormData();
        formData.append('options_file', file);
        
        const response = await fetch(`${API_BASE}/api/parse-options`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            optionsData = data.options;
            const keyData = {
                minecraftId: data.minecraft_id,
                titleAccountId: data.title_account_id
            };
            
            displayOptionsInfo(keyData, data.total_options);
            
            // å¦‚æœæœ‰å…³é”®ä¿¡æ¯ï¼Œå¯ç”¨"ä¼ å…¥ENTè§£å¯†"æŒ‰é’®
            if (keyData.minecraftId || keyData.titleAccountId) {
                document.getElementById('useOptionsBtn').disabled = false;
            }
            
            showToast('Options.txtæ–‡ä»¶è§£ææˆåŠŸ', 'success');
        } else {
            throw new Error(data.error || 'è§£æå¤±è´¥');
        }
        
    } catch (error) {
        showToast('è§£æOptions.txtæ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
        
        // å¦‚æœAPIå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°è§£æ
        try {
            const text = await file.text();
            const lines = text.split('\n');
            
            optionsData = {};
            const keyData = {};
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine && trimmedLine.includes(':')) {
                    const [key, value] = trimmedLine.split(':', 2);
                    const cleanKey = key.trim();
                    const cleanValue = value.trim();
                    
                    optionsData[cleanKey] = cleanValue;
                    
                    // æå–å…³é”®ä¿¡æ¯
                    if (cleanKey === 'last_minecraft_id') {
                        keyData.minecraftId = cleanValue.toUpperCase();
                    } else if (cleanKey === 'last_title_account_id') {
                        keyData.titleAccountId = cleanValue.toUpperCase();
                    }
                }
            });
            
            displayOptionsInfo(keyData, Object.keys(optionsData).length);
            
            // å¦‚æœæœ‰å…³é”®ä¿¡æ¯ï¼Œå¯ç”¨"ä¼ å…¥ENTè§£å¯†"æŒ‰é’®
            if (keyData.minecraftId || keyData.titleAccountId) {
                document.getElementById('useOptionsBtn').disabled = false;
            }
            
            showToast('Options.txtæ–‡ä»¶æœ¬åœ°è§£ææˆåŠŸ', 'success');
            
        } catch (localError) {
            showToast('Options.txtæ–‡ä»¶è§£æå®Œå…¨å¤±è´¥: ' + localError.message, 'error');
        }
    }
}

// æ˜¾ç¤ºOptionsä¿¡æ¯
function displayOptionsInfo(keyData, totalKeys) {
    const optionsInfo = document.getElementById('optionsInfo');
    const optionsDetails = document.getElementById('optionsDetails');
    const accountInfo = document.getElementById('accountInfo');
    
    let detailsHTML = `
        <div class="options-key-value">
            <span class="options-key">é…ç½®é¡¹æ€»æ•°</span>
            <span class="options-value">${totalKeys}</span>
        </div>
    `;
    
    // ä¼˜å…ˆæ˜¾ç¤º Title Account ID
    if (keyData.titleAccountId) {
        detailsHTML += `
            <div class="options-key-value">
                <span class="options-key">Title Account ID</span>
                <span class="options-value">${keyData.titleAccountId}</span>
            </div>
        `;
    }
    
    if (keyData.minecraftId) {
        detailsHTML += `
            <div class="options-key-value">
                <span class="options-key">Minecraft ID</span>
                <span class="options-value">${keyData.minecraftId}</span>
            </div>
        `;
    }
    
    optionsDetails.innerHTML = detailsHTML;
    
    // æ›´æ–°ä¾§è¾¹æ è´¦æˆ·ä¿¡æ¯ï¼Œä¼˜å…ˆæ˜¾ç¤º Title Account ID
    let accountHTML = '';
    if (keyData.titleAccountId) {
        accountHTML += `<div><strong>Title Account ID:</strong><br><code>${keyData.titleAccountId}</code></div>`;
    }
    if (keyData.minecraftId) {
        accountHTML += `<div style="margin-top: 0.5rem;"><strong>Minecraft ID:</strong><br><code>${keyData.minecraftId}</code></div>`;
    }
    
    if (!accountHTML) {
        accountHTML = '<div style="text-align: center; color: var(--text-secondary);">æœªæ‰¾åˆ°å…³é”®è´¦æˆ·ä¿¡æ¯</div>';
    }
    
    accountInfo.innerHTML = accountHTML;
    optionsInfo.style.display = 'block';
}

// ä½¿ç”¨Optionsæ•°æ®è¿›è¡ŒENTè§£å¯†
function useOptionsForEnt() {
    if (!optionsData) {
        showToast('è¯·å…ˆä¸Šä¼ options.txtæ–‡ä»¶', 'error');
        return;
    }
    
    // ä¼˜å…ˆä½¿ç”¨ Title Account IDï¼Œå…¶æ¬¡ä½¿ç”¨ Minecraft ID
    const titleAccountId = optionsData['last_title_account_id'];
    const minecraftId = optionsData['last_minecraft_id'];
    
    const accountId = titleAccountId || minecraftId;
    
    if (!accountId) {
        showToast('Options.txtä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„è´¦æˆ·ID', 'error');
        return;
    }
    
    // åˆ‡æ¢åˆ°ENTæ ‡ç­¾é¡µ
    switchTab('ent');
    
    // å¡«å…¥è´¦æˆ·ID
    document.getElementById('minecraftId').value = accountId.toUpperCase();
    
    const idType = titleAccountId ? 'Title Account ID' : 'Minecraft ID';
    showToast(`${idType}å·²è‡ªåŠ¨å¡«å…¥ENTè§£å¯†é¡µé¢`, 'success');
}

// æ˜¾ç¤ºENTæ–‡ä»¶ä¿¡æ¯
function displayEntFile(file) {
    const fileListSection = document.getElementById('fileListSection');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');

    fileList.innerHTML = '';
    fileCount.textContent = 1;

    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
        <div class="file-info">
            <div class="file-icon" style="background: var(--info);">
                <i class="fas fa-file-code"></i>
            </div>
            <div class="file-details">
                <h4>${file.name}</h4>
                <p>${formatFileSize(file.size)} â€¢ ENTæˆæƒæ–‡ä»¶</p>
            </div>
        </div>
    `;
    fileList.appendChild(fileItem);

    fileListSection.style.display = 'block';
}

// å¤„ç†é€‰æ‹©çš„æ–‡ä»¶ï¼ˆå¯¹äºencrypt/decryptæ¨¡å¼ï¼‰
async function processSelectedFiles(files) {
    // æ£€æŸ¥æ˜¯å¦æœ‰ZIPæ–‡ä»¶
    const zipFiles = files.filter(file => 
        file.name.toLowerCase().endsWith('.zip') || 
        file.name.toLowerCase().endsWith('.mcpack')
    );
    
    if (zipFiles.length > 0) {
        // å¦‚æœæœ‰ZIPæ–‡ä»¶ï¼Œå…ˆè§£å‹
        await handleZipFiles(zipFiles, files);
    } else {
        // æ²¡æœ‰ZIPæ–‡ä»¶ï¼Œç›´æ¥å¤„ç†
        selectedFiles = files;
        displayFileList(files);
        updateProcessButton();
    }
}

// å¤„ç†ZIPæ–‡ä»¶
async function handleZipFiles(zipFiles, allFiles) {
    if (isProcessingZip) {
        showToast('æ­£åœ¨å¤„ç†ZIPæ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'warning');
        return;
    }
    
    isProcessingZip = true;
    showToast('æ­£åœ¨è§£å‹ZIPæ–‡ä»¶...', 'info');
    
    try {
        extractedFiles = [];
        const nonZipFiles = allFiles.filter(file => 
            !file.name.toLowerCase().endsWith('.zip') && 
            !file.name.toLowerCase().endsWith('.mcpack')
        );
        
        // æ·»åŠ éZIPæ–‡ä»¶
        extractedFiles.push(...nonZipFiles);
        
        // å¤„ç†æ¯ä¸ªZIPæ–‡ä»¶
        for (const zipFile of zipFiles) {
            const extractedFromZip = await extractZipFile(zipFile);
            extractedFiles.push(...extractedFromZip);
        }
        
        // æ˜¾ç¤ºè§£å‹ç»“æœ
        selectedFiles = extractedFiles;
        displayFileList(extractedFiles);
        updateProcessButton();
        
        showToast(`æˆåŠŸè§£å‹ ${zipFiles.length} ä¸ªZIPæ–‡ä»¶ï¼Œå…±æå– ${extractedFiles.length} ä¸ªæ–‡ä»¶`, 'success');
        
    } catch (error) {
        console.error('ZIPæ–‡ä»¶å¤„ç†å¤±è´¥:', error);
        showToast('ZIPæ–‡ä»¶è§£å‹å¤±è´¥: ' + error.message, 'error');
        
        // å¦‚æœè§£å‹å¤±è´¥ï¼Œå›é€€åˆ°åŸå§‹æ–‡ä»¶
        selectedFiles = allFiles;
        displayFileList(allFiles);
        updateProcessButton();
    } finally {
        isProcessingZip = false;
    }
}

// è§£å‹å•ä¸ªZIPæ–‡ä»¶
async function extractZipFile(zipFile) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const zip = new JSZip();
                const zipData = await zip.loadAsync(e.target.result);
                const extractedFiles = [];
                
                // éå†ZIPä¸­çš„æ‰€æœ‰æ–‡ä»¶
                for (const [fileName, fileObj] of Object.entries(zipData.files)) {
                    // è·³è¿‡ç›®å½•
                    if (fileObj.dir) continue;
                    
                    // è·å–æ–‡ä»¶å†…å®¹
                    const fileContent = await fileObj.async('blob');
                    
                    // åˆ›å»ºæ–°çš„Fileå¯¹è±¡
                    const extractedFile = new File([fileContent], fileName, {
                        type: getFileType(fileName),
                        lastModified: fileObj.date ? fileObj.date.getTime() : Date.now()
                    });
                    
                    // æ·»åŠ åŸå§‹ZIPæ–‡ä»¶ä¿¡æ¯
                    extractedFile.sourceZip = zipFile.name;
                    extractedFile.originalPath = fileName;
                    
                    extractedFiles.push(extractedFile);
                }
                
                resolve(extractedFiles);
            } catch (error) {
                reject(new Error(`è§£å‹ ${zipFile.name} å¤±è´¥: ${error.message}`));
            }
        };
        
        reader.onerror = () => reject(new Error(`è¯»å– ${zipFile.name} å¤±è´¥`));
        reader.readAsArrayBuffer(zipFile);
    });
}

// æ ¹æ®æ–‡ä»¶ååˆ¤æ–­MIMEç±»å‹
function getFileType(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const typeMap = {
        'json': 'application/json',
        'png': 'image/png',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'gif': 'image/gif',
        'txt': 'text/plain',
        'js': 'text/javascript',
        'css': 'text/css',
        'html': 'text/html',
        'wav': 'audio/wav',
        'ogg': 'audio/ogg',
        'mcmeta': 'application/json',
        'mcfunction': 'text/plain',
        'ent': 'text/plain'
    };
    
    return typeMap[ext] || 'application/octet-stream';
}

// ä¿®æ”¹æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨å‡½æ•°ï¼Œæ˜¾ç¤ºè§£å‹ä¿¡æ¯
function displayFileList(files) {
    const fileListSection = document.getElementById('fileListSection');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');

    fileList.innerHTML = '';
    fileCount.textContent = files.length;

    // ç»Ÿè®¡ZIPæ¥æº
    const zipSources = {};
    const regularFiles = [];
    
    files.forEach(file => {
        if (file.sourceZip) {
            if (!zipSources[file.sourceZip]) {
                zipSources[file.sourceZip] = [];
            }
            zipSources[file.sourceZip].push(file);
        } else {
            regularFiles.push(file);
        }
    });

    let displayCount = 0;
    const maxDisplay = 20;

    // æ˜¾ç¤ºZIPæ¥æºçš„æ–‡ä»¶
    for (const [zipName, zipFiles] of Object.entries(zipSources)) {
        if (displayCount >= maxDisplay) break;
        
        // ZIPæ–‡ä»¶ç»„æ ‡é¢˜
        const zipGroupItem = document.createElement('div');
        zipGroupItem.className = 'file-item';
        zipGroupItem.style.backgroundColor = 'var(--bg)';
        zipGroupItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon" style="background: var(--info);">
                    <i class="fas fa-file-archive"></i>
                </div>
                <div class="file-details">
                    <h4>ğŸ“¦ ${zipName}</h4>
                    <p>åŒ…å« ${zipFiles.length} ä¸ªæ–‡ä»¶</p>
                </div>
            </div>
        `;
        fileList.appendChild(zipGroupItem);
        displayCount++;

        // æ˜¾ç¤ºZIPä¸­çš„æ–‡ä»¶ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
        const filesToShow = zipFiles.slice(0, 5);
        filesToShow.forEach(file => {
            if (displayCount >= maxDisplay) return;
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.style.marginLeft = '20px';
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas ${getFileIcon(file.name)}"></i>
                    </div>
                    <div class="file-details">
                        <h4>${file.originalPath || file.name}</h4>
                        <p>${formatFileSize(file.size)} â€¢ æ¥è‡ªZIP</p>
                    </div>
                </div>
            `;
            fileList.appendChild(fileItem);
            displayCount++;
        });

        // å¦‚æœZIPä¸­æ–‡ä»¶å¤ªå¤šï¼Œæ˜¾ç¤ºçœç•¥ä¿¡æ¯
        if (zipFiles.length > 5) {
            const moreItem = document.createElement('div');
            moreItem.className = 'file-item';
            moreItem.style.marginLeft = '20px';
            moreItem.style.opacity = '0.7';
            moreItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="file-details">
                        <h4>è¿˜æœ‰ ${zipFiles.length - 5} ä¸ªæ–‡ä»¶...</h4>
                        <p>æ¥è‡ª ${zipName}</p>
                    </div>
                </div>
            `;
            fileList.appendChild(moreItem);
            displayCount++;
        }
    }

    // æ˜¾ç¤ºå¸¸è§„æ–‡ä»¶
    regularFiles.slice(0, maxDisplay - displayCount).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">
                    <i class="fas ${getFileIcon(file.name)}"></i>
                </div>
                <div class="file-details">
                    <h4>${file.name}</h4>
                    <p>${formatFileSize(file.size)}</p>
                </div>
            </div>
        `;
        fileList.appendChild(fileItem);
        displayCount++;
    });

    // å¦‚æœè¿˜æœ‰æ›´å¤šæ–‡ä»¶æœªæ˜¾ç¤º
    const remainingFiles = files.length - displayCount;
    if (remainingFiles > 0) {
        const moreItem = document.createElement('div');
        moreItem.className = 'file-item';
        moreItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">
                    <i class="fas fa-ellipsis-h"></i>
                </div>
                <div class="file-details">
                    <h4>è¿˜æœ‰ ${remainingFiles} ä¸ªæ–‡ä»¶...</h4>
                    <p>ç‚¹å‡»æŸ¥çœ‹å…¨éƒ¨</p>
                </div>
            </div>
        `;
        fileList.appendChild(moreItem);
    }

    fileListSection.style.display = files.length > 0 ? 'block' : 'none';
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'json': return 'fa-file-code';
        case 'png': case 'jpg': case 'jpeg': return 'fa-image';
        case 'zip': case 'mcpack': case 'mcworld': case 'mctemplate': return 'fa-file-archive';
        case 'ent': return 'fa-file-code';
        case 'txt': return 'fa-file-text';
        default: return 'fa-file';
    }
}

function updateProcessButton() {
    const processBtn = document.getElementById('processBtn');
    
    if (currentMode === 'options') {
        // Optionsæ¨¡å¼ï¼šå¦‚æœå·²æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºä¸ºå·²è§£æçŠ¶æ€
        if (optionsData) {
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-check"></i> å·²è§£æOptions.txt';
        } else {
            processBtn.disabled = selectedFiles.length === 0;
        }
    } else {
        processBtn.disabled = selectedFiles.length === 0;
    }
}

function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('entResultsSection').style.display = 'none';
    document.getElementById('downloadBtn').classList.add('hidden');
    document.getElementById('fileListSection').style.display = 'none';
    currentDownloadFilename = null;
}

// æ£€æŸ¥APIçŠ¶æ€
async function checkApiStatus() {
    const statusElement = document.getElementById('api-status');
    
    try {
        const response = await fetch(`${API_BASE}/api/health`);
        const data = await response.json();
        
        if (data.status === 'ok') {
            statusElement.className = 'status-indicator status-online';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> æœåŠ¡åœ¨çº¿';
        } else {
            throw new Error('APIè¿”å›é”™è¯¯çŠ¶æ€');
        }
    } catch (error) {
        statusElement.className = 'status-indicator status-offline';
        statusElement.innerHTML = '<i class="fas fa-circle"></i> æœåŠ¡ç¦»çº¿';
        console.error('APIçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
    }
}

// ç”Ÿæˆå¯†é’¥
async function generateKey() {
    const customKeyInput = document.getElementById('customKey');
    
    try {
        const response = await fetch(`${API_BASE}/api/generate-key`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            customKeyInput.value = data.key;
            showToast('å¯†é’¥ç”ŸæˆæˆåŠŸï¼', 'success');
        } else {
            throw new Error(data.error || 'ç”Ÿæˆå¯†é’¥å¤±è´¥');
        }
    } catch (error) {
        showToast('ç”Ÿæˆå¯†é’¥å¤±è´¥: ' + error.message, 'error');
        console.error('ç”Ÿæˆå¯†é’¥å¤±è´¥:', error);
    }
}

// é‡æ–°æ‰“åŒ…ä¸ºZIPçš„è¾…åŠ©å‡½æ•°
async function repackAsZip(files, zipName = 'extracted_files.zip') {
    const zip = new JSZip();
    
    for (const file of files) {
        const fileName = file.originalPath || file.webkitRelativePath || file.name;
        zip.file(fileName, file);
    }
    
    const zipBlob = await zip.generateAsync({type: 'blob'});
    return new File([zipBlob], zipName, {type: 'application/zip'});
}

// å¤„ç†æ–‡ä»¶ï¼ˆåŠ å¯†ã€è§£å¯†ã€ENTè§£ææˆ–Optionsè§£æï¼‰
async function processFiles() {
    if (selectedFiles.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
        return;
    }

    if (currentMode === 'ent') {
        return processEntFile();
    } else if (currentMode === 'options') {
        return processOptionsOnly();
    }

    const customKey = currentMode === 'decrypt' ? 
        document.getElementById('manualDecryptKey').value : 
        document.getElementById('customKey').value;
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const processBtn = document.getElementById('processBtn');
    const resultsSection = document.getElementById('resultsSection');

    // é‡ç½®UI
    resultsSection.style.display = 'none';
    progressSection.style.display = 'block';
    processBtn.disabled = true;
    
    const actionText = currentMode === 'encrypt' ? 'åŠ å¯†' : 'æ™ºèƒ½è§£å¯†';
    processBtn.innerHTML = `<span class="spinner"></span> ${actionText}ä¸­...`;

    try {
        // åˆ›å»ºFormData
        const formData = new FormData();
        
        // å¦‚æœæœ‰è§£å‹çš„æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°æ‰“åŒ…ä¸ºZIP
        if (selectedFiles.some(file => file.sourceZip)) {
            updateProgress(10, 'æ­£åœ¨é‡æ–°æ‰“åŒ…æ–‡ä»¶...');
            const repackedZip = await repackAsZip(selectedFiles, 'processed_files.zip');
            formData.append('files', repackedZip);
        } else {
            // æ·»åŠ åŸå§‹æ–‡ä»¶
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
        }
        
        // æ·»åŠ è‡ªå®šä¹‰å¯†é’¥
        if (customKey.trim()) {
            formData.append('custom_key', customKey.trim());
        }

        // æ›´æ–°è¿›åº¦
        updateProgress(30, `æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...`);

        // é€‰æ‹©APIç«¯ç‚¹
        const endpoint = currentMode === 'encrypt' ? '/api/encrypt' : '/api/decrypt';

        // å‘é€è¯·æ±‚
        const response = await fetch(`${API_BASE}${endpoint}`, {
            method: 'POST',
            body: formData
        });

        updateProgress(70, `æ­£åœ¨${actionText}æ–‡ä»¶...`);

        const data = await response.json();

        if (data.success) {
            updateProgress(100, `${actionText}å®Œæˆï¼`);
            
            setTimeout(() => {
                displayProcessResult(data);
                progressSection.style.display = 'none';
            }, 1000);
        } else {
            throw new Error(data.error || `${actionText}å¤±è´¥`);
        }

    } catch (error) {
        console.error(`${actionText}å¤±è´¥:`, error);
        showToast(`${actionText}å¤±è´¥: ` + error.message, 'error');
        progressSection.style.display = 'none';
    } finally {
        // æ¢å¤æŒ‰é’®
        processBtn.disabled = false;
        const icon = currentMode === 'encrypt' ? 'fa-lock' : 'fa-magic';
        const text = currentMode === 'encrypt' ? 'å¼€å§‹åŠ å¯†' : 'æ™ºèƒ½è§£å¯†';
        processBtn.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }
}

// å¤„ç†Options.txtæ–‡ä»¶ï¼ˆä»…è§£æï¼‰
async function processOptionsOnly() {
    if (optionsData) {
        showToast('Options.txtæ–‡ä»¶å·²è§£æå®Œæˆ', 'info');
        return;
    }
    
    const file = selectedFiles[0];
    await processOptionsFile(file);
}

// å¤„ç†ENTæ–‡ä»¶
async function processEntFile() {
    const entFile = selectedFiles[0];
    const minecraftId = document.getElementById('minecraftId').value.trim();
    const outputFormat = document.getElementById('entOutputFormat').value;
    
    const progressSection = document.getElementById('progressSection');
    const processBtn = document.getElementById('processBtn');

    // é‡ç½®UI
    progressSection.style.display = 'block';
    processBtn.disabled = true;
    processBtn.innerHTML = `<span class="spinner"></span> è§£æä¸­...`;

    try {
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('ent_file', entFile);
        
        if (minecraftId) {
            formData.append('minecraft_id', minecraftId);
        }
        
        formData.append('output_format', outputFormat);

        updateProgress(30, 'æ­£åœ¨ä¸Šä¼ ENTæ–‡ä»¶...');

        // å‘é€è¯·æ±‚
        const response = await fetch(`${API_BASE}/api/decrypt-ent`, {
            method: 'POST',
            body: formData
        });

        updateProgress(70, 'æ­£åœ¨è§£æENTæ–‡ä»¶...');

        const data = await response.json();

        if (data.success) {
            updateProgress(100, 'ENTè§£æå®Œæˆï¼');
            
            // ä¿å­˜å¯†é’¥æ•°æ®å¹¶æ›´æ–°æ•°æ®åº“
            entKeys = data.keys || [];
            addKeysToDatabase(entKeys);
            
            setTimeout(() => {
                displayEntResult(data);
                progressSection.style.display = 'none';
            }, 1000);
        } else {
            throw new Error(data.error || 'ENTè§£æå¤±è´¥');
        }

    } catch (error) {
        console.error('ENTè§£æå¤±è´¥:', error);
        showToast('ENTè§£æå¤±è´¥: ' + error.message, 'error');
        progressSection.style.display = 'none';
    } finally {
        // æ¢å¤æŒ‰é’®
        processBtn.disabled = false;
        processBtn.innerHTML = '<i class="fas fa-key"></i> è§£æENTæ–‡ä»¶';
    }
}

// æ˜¾ç¤ºENTè§£æç»“æœ
function displayEntResult(data) {
    const entResultsSection = document.getElementById('entResultsSection');
    const fileListSection = document.getElementById('fileListSection');
    const entResultInfo = document.getElementById('entResultInfo');
    const keyList = document.getElementById('keyList');
    const keyCount = document.getElementById('keyCount');
    const downloadBtn = document.getElementById('downloadBtn');

    // éšè—æ–‡ä»¶åˆ—è¡¨çª—å£
    fileListSection.style.display = 'none';

    // æ›´æ–°å¯†é’¥æ•°é‡
    keyCount.textContent = data.keys ? data.keys.length : 0;

    // æ„å»ºENTæ–‡ä»¶ä¿¡æ¯
    let infoHTML = `
        <div class="pack-info-item">
            <span class="pack-info-label">æ–‡ä»¶å</span>
            <span class="pack-info-value">${selectedFiles[0].name}</span>
        </div>
        <div class="pack-info-item">
            <span class="pack-info-label">æ–‡ä»¶å¤§å°</span>
            <span class="pack-info-value">${formatFileSize(selectedFiles[0].size)}</span>
        </div>
        <div class="pack-info-item">
            <span class="pack-info-label">æ–‡ä»¶ç±»å‹</span>
            <span class="pack-info-value">${data.file_type || 'æœªçŸ¥'}</span>
        </div>
        <div class="pack-info-item">
            <span class="pack-info-label">ä¿å­˜å¯†é’¥æ•°</span>
            <span class="pack-info-value">${data.keys ? data.keys.length : 0}</span>
        </div>
    `;

    if (data.user_info) {
        infoHTML += `
            <div class="pack-info-item">
                <span class="pack-info-label">ç”¨æˆ·ID</span>
                <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${data.user_info.user_id || 'æœªçŸ¥'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">è®¾å¤‡ID</span>
                <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${data.user_info.device_id || 'æœªçŸ¥'}</span>
            </div>
        `;
    }

    entResultInfo.innerHTML = infoHTML;

    // æ˜¾ç¤ºå¯†é’¥åˆ—è¡¨
    keyList.innerHTML = '';
    
    if (data.keys && data.keys.length > 0) {
        data.keys.forEach((key, index) => {
            const keyItem = document.createElement('div');
            keyItem.className = 'key-item';
            keyItem.innerHTML = `
                <div class="key-info">
                    <div class="key-uuid">${key.id || key.uuid || `å¯†é’¥ ${index + 1}`}</div>
                    <div class="key-value">${key.contentKey || key.content_key || 'æœªçŸ¥å¯†é’¥'}</div>
                </div>
                <button class="copy-btn" onclick="copyToClipboard('${key.contentKey || key.content_key || ''}', this)">
                    <i class="fas fa-copy"></i>
                    å¤åˆ¶
                </button>
            `;
            keyList.appendChild(keyItem);
        });
    } else {
        keyList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">æœªæ‰¾åˆ°ä»»ä½•å¯†é’¥</div>';
    }

    // è®¾ç½®ä¸‹è½½åŠŸèƒ½
    if (data.download_filename) {
        currentDownloadFilename = data.download_filename;
        downloadBtn.classList.remove('hidden');
    }

    entResultsSection.style.display = 'block';
    showToast(`ENTæ–‡ä»¶è§£ææˆåŠŸï¼å·²ä¿å­˜ ${data.keys ? data.keys.length : 0} ä¸ªå¯†é’¥åˆ°æ•°æ®åº“`, 'success');
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿
async function copyToClipboard(text, button) {
    try {
        await navigator.clipboard.writeText(text);
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
        button.style.background = 'var(--success)';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = 'var(--info)';
        }, 2000);
        
        showToast('å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    } catch (error) {
        showToast('å¤åˆ¶å¤±è´¥: ' + error.message, 'error');
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress(percent, text) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    progressFill.style.width = percent + '%';
    progressText.textContent = text;
}

// æ˜¾ç¤ºå¤„ç†ç»“æœ
function displayProcessResult(data) {
    const resultsSection = document.getElementById('resultsSection');
    const fileListSection = document.getElementById('fileListSection');
    const processedFiles = document.getElementById('processedFiles');
    const totalFiles = document.getElementById('totalFiles');
    const packageName = document.getElementById('packageName');
    const operationKey = document.getElementById('operationKey');
    const packDetailsInfo = document.getElementById('packDetailsInfo');
    const downloadBtn = document.getElementById('downloadBtn');
    const resultTitle = document.getElementById('resultTitle');
    const processedLabel = document.getElementById('processedLabel');
    const keyMatchingStatus = document.getElementById('keyMatchingStatus');
    const keyMatchingText = document.getElementById('keyMatchingText');
    const keyLabel = document.getElementById('keyLabel');

    // éšè—æ–‡ä»¶åˆ—è¡¨çª—å£
    fileListSection.style.display = 'none';

    // æ›´æ–°æ ‡é¢˜å’Œæ ‡ç­¾
    if (currentMode === 'encrypt') {
        resultTitle.textContent = 'åŠ å¯†ç»“æœ';
        processedLabel.textContent = 'åŠ å¯†æ–‡ä»¶æ•°';
        processedFiles.textContent = data.encrypted_files || 0;
        keyLabel.textContent = 'ç”Ÿæˆå¯†é’¥';
        keyMatchingStatus.style.display = 'none';
    } else {
        resultTitle.textContent = 'æ™ºèƒ½è§£å¯†ç»“æœ';
        processedLabel.textContent = 'è§£å¯†æ–‡ä»¶æ•°';
        processedFiles.textContent = data.decrypted_files || 0;
        keyLabel.textContent = 'åŒ¹é…å¯†é’¥';
        
        // æ˜¾ç¤ºå¯†é’¥åŒ¹é…çŠ¶æ€
        keyMatchingStatus.style.display = 'flex';
        if (data.pack_uuid && data.used_key) {
            keyMatchingText.textContent = 'æ™ºèƒ½åŒ¹é…æˆåŠŸ';
            keyMatchingStatus.style.color = 'var(--success)';
        } else {
            keyMatchingText.textContent = 'ä½¿ç”¨é»˜è®¤å¯†é’¥';
            keyMatchingStatus.style.color = 'var(--warning)';
        }
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    totalFiles.textContent = data.total_files || 0;
    
    if (data.pack_info && data.pack_info.name) {
        packageName.textContent = data.pack_info.name.substring(0, 10) + (data.pack_info.name.length > 10 ? '...' : '');
        packageName.title = data.pack_info.name;
    } else {
        packageName.textContent = 'æœªçŸ¥';
    }
    
    const keyValue = data.content_key || data.used_key || 's5s5ejuDru4uchuF2drUFuthaspAbepE';
    operationKey.textContent = keyValue.substring(0, 8) + '...';
    operationKey.title = keyValue;

    // æ„å»ºè¯¦ç»†ä¿¡æ¯
    let detailsHTML = '';
    
    if (data.pack_info) {
        const info = data.pack_info;
        detailsHTML += `
            <div class="pack-info-item">
                <span class="pack-info-label">åŒ…åç§°</span>
                <span class="pack-info-value">${info.name || 'æœªçŸ¥'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">æè¿°</span>
                <span class="pack-info-value">${info.description || 'æ— '}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">ç‰ˆæœ¬</span>
                <span class="pack-info-value">${info.version || '0.0.0'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">UUID</span>
                <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${info.uuid || 'æœªçŸ¥'}</span>
            </div>
        `;
    }
    
    detailsHTML += `
        <div class="pack-info-item">
            <span class="pack-info-label">${currentMode === 'encrypt' ? 'ç”Ÿæˆå¯†é’¥' : 'ä½¿ç”¨å¯†é’¥'}</span>
            <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${keyValue}</span>
        </div>
    `;

    // å¦‚æœæ˜¯è§£å¯†æ¨¡å¼ï¼Œæ˜¾ç¤ºå¯†é’¥åŒ¹é…è¯¦æƒ…
    if (currentMode === 'decrypt') {
        detailsHTML += `
            <div class="pack-info-item">
                <span class="pack-info-label">å¯†é’¥æ¥æº</span>
                <span class="pack-info-value">${data.pack_uuid ? 'UUIDæ™ºèƒ½åŒ¹é…' : 'é»˜è®¤å¯†é’¥'}</span>
            </div>
        `;
    }

    packDetailsInfo.innerHTML = detailsHTML;

    // è®¾ç½®ä¸‹è½½åŠŸèƒ½
    if (data.download_filename) {
        currentDownloadFilename = data.download_filename;
        downloadBtn.classList.remove('hidden');
    }

    resultsSection.style.display = 'block';
    const actionText = currentMode === 'encrypt' ? 'åŠ å¯†' : 'æ™ºèƒ½è§£å¯†';
    showToast(`åŒ…${actionText}æˆåŠŸï¼`, 'success');
}

// ä¸‹è½½ç»“æœ
function downloadResult() {
    if (currentDownloadFilename) {
        downloadFile(currentDownloadFilename);
    } else {
        showToast('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶', 'error');
    }
}

// ä¸‹è½½æ–‡ä»¶
async function downloadFile(filename) {
    try {
        const response = await fetch(`${API_BASE}/api/download/${filename}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('æ–‡ä»¶ä¸‹è½½å¼€å§‹', 'success');
        } else {
            throw new Error('ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        showToast('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
        console.error('ä¸‹è½½å¤±è´¥:', error);
    }
}

// æ¸…ç†æ–‡ä»¶
async function cleanupFiles() {
    try {
        const response = await fetch(`${API_BASE}/api/cleanup`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ', 'success');
        } else {
            throw new Error(data.error || 'æ¸…ç†å¤±è´¥');
        }
    } catch (error) {
        showToast('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
        console.error('æ¸…ç†å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºToasté€šçŸ¥
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    let icon = 'fa-info-circle';
    if (type === 'success') icon = 'fa-check-circle';
    else if (type === 'error') icon = 'fa-exclamation-triangle';
    else if (type === 'warning') icon = 'fa-exclamation-triangle';
    
    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        ${message}
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>

<style>
/* æ·»åŠ ä¸€äº›æ–°çš„æ ·å¼ */
.ent-workflow-info {
    --info-bg: rgba(59, 130, 246, 0.1);
}

.workflow-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.workflow-step {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.step-number {
    background: var(--info);
    color: white;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.step-content strong {
    color: var(--text);
    display: block;
    margin-bottom: 0.25rem;
}

.step-content p {
    margin: 0;
    color: var(--text-secondary);
}

.key-database-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 0.5rem;
}

.status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.status-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.status-value {
    font-weight: bold;
    color: var(--text);
}

.smart-decrypt-info {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
}

.priority-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.priority-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.priority-number {
    background: var(--info);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

.priority-text {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.key-library-status {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.status-header {
    background: var(--info);
    color: white;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    font-weight: bold;
}

.status-content {
    padding: 0.75rem;
}

.status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.status-row:last-child {
    margin-bottom: 0;
}

.status-row span:first-child {
    color: var(--text-secondary);
}

.status-row span:last-child {
    color: var(--text);
    font-weight: bold;
}

.key-matching-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--success);
    font-size: 0.9rem;
}

.database-save-notice {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--success);
    border-radius: var(--radius);
    padding: 1rem;
}

.database-save-notice h4 {
    color: var(--success);
    margin-bottom: 0.5rem;
}

.database-save-notice p {
    color: var(--success);
    margin: 0;
}
</style>
</body>
</html>
