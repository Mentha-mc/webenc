
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minecraft包加密/解密工具</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<link rel="stylesheet" href="./main.css">
</head>
<body>
<!-- 移动端警告遮罩 -->
<div class="mobile-warning-overlay" id="mobileWarning" style="display: none;">
<div class="mobile-warning-content">
    <div class="mobile-warning-icon">
        <i class="fas fa-mobile-alt"></i>
    </div>
    <h2>移动端不支持</h2>
    <p>抱歉，此工具需要在桌面端浏览器中使用，因为需要处理文件夹和大量文件操作。</p>
    <div style="margin: 1.5rem 0;">
        <h3>为什么不支持移动端？</h3>
        <ul style="text-align: left; margin-top: 1rem;">
            <li><i class="fas fa-folder"></i> 需要文件夹拖拽功能</li>
            <li><i class="fas fa-file-archive"></i> 需要处理ZIP文件</li>
            <li><i class="fas fa-memory"></i> 需要大量内存处理文件</li>
            <li><i class="fas fa-download"></i> 需要批量下载功能</li>
        </ul>
    </div>
    <button class="btn btn-primary" onclick="closeMobileWarning()">
        <i class="fas fa-times"></i>
        我了解了
    </button>
</div>
</div>

<!-- Header -->
<div class="header">
<div class="header-content">
    <div class="brand">
        <div class="logo"><i class="fas fa-shield-alt"></i></div>
        <div class="brand-text">
            <h1>Minecraft包加密/解密工具</h1>
            <div class="brand-subtitle">智能ENT密钥匹配，安全快速地加密或解密您的Minecraft资源包和行为包</div>
        </div>
        <div id="api-status" class="status-indicator status-offline">
            <i class="fas fa-circle"></i>
            检查中...
        </div>
    </div>
</div>
</div>

<!-- Main Content -->
<div class="main-container">
<!-- Content Area -->
<div class="content-area">
    <!-- Tab Navigation -->
    <div class="tab-container">
        <button class="tab-button active" onclick="switchTab('encrypt')">
            <i class="fas fa-lock"></i>
            加密包
        </button>
        <button class="tab-button" onclick="switchTab('decrypt')">
            <i class="fas fa-unlock"></i>
            解密包
        </button>
        <button class="tab-button" onclick="switchTab('ent')">
            <i class="fas fa-key"></i>
            ENT解密
        </button>
        <button class="tab-button" onclick="switchTab('options')">
            <i class="fas fa-cog"></i>
            Options.txt
        </button>
    </div>

    <!-- Encrypt Tab Content -->
    <div id="encrypt-tab" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-upload"></i>
                    选择要加密的包文件
                </div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="encryptUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>拖拽文件夹到这里</h3>
                    <p>或者点击下方按钮选择文件</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('encryptFolderInput').click()">
                            <i class="fas fa-folder-open"></i>
                            选择文件夹
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('encryptFileInput').click()">
                            <i class="fas fa-file-archive"></i>
                            选择ZIP文件
                        </button>
                    </div>
                    <input type="file" id="encryptFolderInput" webkitdirectory multiple style="display: none;">
                    <input type="file" id="encryptFileInput" accept=".zip,.mcpack" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Decrypt Tab Content -->
    <div id="decrypt-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-upload"></i>
                    选择要解密的包文件
                </div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="decryptUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>拖拽加密包到这里</h3>
                    <p>系统会自动匹配最佳密钥进行解密</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('decryptFolderInput').click()">
                            <i class="fas fa-folder-open"></i>
                            选择文件夹
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('decryptFileInput').click()">
                            <i class="fas fa-file-archive"></i>
                            选择ZIP文件
                        </button>
                    </div>
                    <input type="file" id="decryptFolderInput" webkitdirectory multiple style="display: none;">
                    <input type="file" id="decryptFileInput" accept=".zip,.mcpack" style="display: none;">
                </div>
                
                <!-- 密钥数据库状态 -->
                <div class="form-group" style="margin-top: 2rem;">
                    <label class="label">
                        <i class="fas fa-database"></i>
                        密钥数据库状态
                    </label>
                    <div class="key-database-status" id="keyDatabaseStatus">
                        <div class="status-item">
                            <span class="status-label">ENT密钥数量</span>
                            <span class="status-value" id="dbKeyCount">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">匹配算法</span>
                            <span class="status-value">UUID智能匹配</span>
                        </div>
                    </div>
                    <small class="text-secondary">
                        💡 建议先解密ENT文件建立密钥库，系统会自动匹配正确的密钥
                    </small>
                </div>
                
                <!-- ENT授权文件上传区域 -->
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="label">
                        <i class="fas fa-key"></i>
                        快速ENT密钥导入
                    </label>
                    <div class="upload-zone" id="decryptEntUploadZone" style="padding: 1.5rem; border-style: dashed;">
                        <div class="upload-icon" style="font-size: 2rem; margin-bottom: 1rem;">
                            <i class="fas fa-file-code"></i>
                        </div>
                        <h4>直接拖拽ENT文件快速导入密钥</h4>
                        <p style="margin-bottom: 1rem;">ENT密钥会自动保存到密钥库，解密时自动匹配</p>
                        <button class="btn btn-outline" onclick="document.getElementById('decryptEntInput').click()">
                            <i class="fas fa-file-upload"></i>
                            选择ENT文件
                        </button>
                        <input type="file" id="decryptEntInput" accept=".ent" style="display: none;">
                    </div>
                </div>
                
                <!-- Minecraft账户ID -->
                <div class="form-group" style="margin-top: 1rem;">
                    <label class="label">Minecraft账户ID (ENT解密用)</label>
                    <input type="text" class="input" id="decryptMinecraftId" placeholder="如果ENT文件加密，需要输入账户ID">
                    <small class="text-secondary">通常在游戏设置或options.txt中找到</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ENT Decrypt Tab Content -->
    <div id="ent-tab" class="tab-content">
        <div class="card ent-info-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-key"></i>
                    ENT授权文件解密
                </div>
                <div style="margin-left: auto;">
                    <span class="badge badge-info">
                        <i class="fas fa-info-circle"></i>
                        自动建立密钥库
                    </span>
                </div>
            </div>
            <div class="card-content">
                <div class="ent-workflow-info" style="margin-bottom: 2rem; padding: 1.5rem; background: var(--info-bg); border-radius: var(--radius); border: 1px solid var(--info);">
                    <h3 style="margin-bottom: 1rem; color: var(--info);">
                        <i class="fas fa-lightbulb"></i>
                        智能密钥匹配工作流程
                    </h3>
                    <div class="workflow-steps">
                        <div class="workflow-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <strong>解密ENT文件</strong>
                                <p>提取所有包密钥并自动保存到密钥数据库</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <strong>解密加密包</strong>
                                <p>系统自动读取包UUID，匹配正确密钥进行解密</p>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <strong>一键解密成功</strong>
                                <p>无需手动输入密钥，全自动智能匹配</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="upload-zone" id="entUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <h3>上传ENT授权文件</h3>
                    <p>支持加密和未加密的.ent文件，将自动提取并保存所有密钥</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('entFileInput').click()">
                            <i class="fas fa-file-upload"></i>
                            选择ENT文件
                        </button>
                    </div>
                    <input type="file" id="entFileInput" accept=".ent" style="display: none;">
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="label">Minecraft账户ID (可选)</label>
                    <input type="text" class="input" id="minecraftId" placeholder="用于解密加密的ENT文件">
                    <small class="text-secondary">通常在游戏设置或options.txt中找到，如果ENT文件是加密的，需要此信息</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Options.txt Tab Content -->
    <div id="options-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-cog"></i>
                    Options.txt 配置文件
                </div>
            </div>
            <div class="card-content">
                <div class="upload-zone" id="optionsUploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-file-text"></i>
                    </div>
                    <h3>上传Options.txt文件</h3>
                    <p>从Minecraft配置文件中提取账户信息用于ENT解密</p>
                    <div class="upload-buttons">
                        <button class="btn btn-primary" onclick="document.getElementById('optionsFileInput').click()">
                            <i class="fas fa-file-upload"></i>
                            选择Options.txt
                        </button>
                    </div>
                    <input type="file" id="optionsFileInput" accept=".txt" style="display: none;">
                </div>
                
                <div class="options-info" id="optionsInfo" style="display: none;">
                    <h4 style="margin-bottom: 0.5rem;">
                        <i class="fas fa-info-circle"></i>
                        配置文件信息
                    </h4>
                    <div id="optionsDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- File List Section -->
    <div class="card" id="fileListSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-list"></i>
                已选择的文件
            </div>
            <span class="badge badge-success">
                <span id="fileCount">0</span> 个文件
            </span>
        </div>
        <div class="card-content">
            <div class="file-list" id="fileList"></div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="card" id="progressSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-spinner fa-spin"></i>
                处理进度
            </div>
            <span id="progressText">准备中...</span>
        </div>
        <div class="card-content">
            <div class="progress">
                <div class="progress-bar" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="card" id="resultsSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-chart-bar"></i>
                <span id="resultTitle">处理结果</span>
            </div>
            <div id="keyMatchingStatus" class="key-matching-indicator" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="keyMatchingText">智能匹配成功</span>
            </div>
        </div>
        <div class="card-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <div class="stat-value" id="processedFiles">0</div>
                    <div class="stat-label" id="processedLabel">处理文件数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-files"></i>
                    </div>
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">总文件数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div class="stat-value" id="packageName">-</div>
                    <div class="stat-label">包名称</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="stat-value" id="operationKey">-</div>
                    <div class="stat-label" id="keyLabel">使用密钥</div>
                </div>
            </div>
            <div id="packDetailsInfo" class="pack-info" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- ENT Results Section -->
    <div class="card" id="entResultsSection" style="display: none;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-key"></i>
                密钥已保存到数据库
            </div>
            <span class="badge badge-success">
                <span id="keyCount">0</span> 个密钥
            </span>
        </div>
        <div class="card-content">
            <div class="database-save-notice" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius);">
                <h4 style="margin-bottom: 0.5rem; color: var(--success);">
                    <i class="fas fa-database"></i>
                    密钥已自动保存
                </h4>
                <p style="margin: 0; color: var(--success);">
                    所有提取的密钥已保存到密钥数据库。现在您可以直接上传加密包进行解密，系统会自动匹配正确的密钥。
                </p>
            </div>
            <div id="entResultInfo" class="pack-info" style="margin-bottom: 1rem;"></div>
            <div class="key-list" id="keyList"></div>
        </div>
    </div>
</div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Settings Section -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-cog"></i>
                        设置
                    </div>
                </div>
                <div class="card-content">
                    <!-- 加密模式：自定义密钥 -->
                    <div class="form-group" id="customKeyGroup">
                        <label class="label">自定义密钥 (可选)</label>
                        <input type="text" class="input" id="customKey" placeholder="留空将自动生成">
                        <small class="text-secondary">32字符的字母数字组合</small>
                        <button class="btn btn-outline btn-full" onclick="generateKey()">
                            <i class="fas fa-random"></i>
                            生成随机密钥
                        </button>
                    </div>
                    
                    <!-- 解密模式：智能匹配设置 -->
                    <div class="form-group hidden" id="decryptSmartGroup">
                        <label class="label">
                            <i class="fas fa-magic"></i>
                            智能解密设置
                        </label>
                        
                        <div class="smart-decrypt-info" style="margin: 1rem 0; padding: 1rem; background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
                            <h4 style="margin-bottom: 0.5rem; color: var(--text);">
                                <i class="fas fa-brain"></i>
                                密钥选择优先级
                            </h4>
                            <div class="priority-list">
                                <div class="priority-item">
                                    <span class="priority-number">1</span>
                                    <span class="priority-text">用户自定义密钥</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-number">2</span>
                                    <span class="priority-text">UUID匹配密钥</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-number">3</span>
                                    <span class="priority-text">默认皮肤密钥</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="label">手动密钥覆盖 (高级)</label>
                            <input type="text" class="input" id="manualDecryptKey" placeholder="留空使用智能匹配">
                            <small class="text-secondary">仅在智能匹配失败时手动指定</small>
                        </div>
                        
                        <!-- 密钥库状态 -->
                        <div class="key-library-status" style="margin-top: 1rem;">
                            <div class="status-header">
                                <i class="fas fa-database"></i>
                                密钥库状态
                            </div>
                            <div class="status-content" id="keyLibraryContent">
                                <div class="status-row">
                                    <span>ENT密钥数量</span>
                                    <span id="sidebarKeyCount">0</span>
                                </div>
                                <div class="status-row">
                                    <span>数据库状态</span>
                                    <span id="dbStatus">空</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group hidden" id="entOptionsGroup">
                        <label class="label">输出格式</label>
                        <select class="input" id="entOutputFormat">
                            <option value="json">JSON格式</option>
                            <option value="keys_db">Keys.db格式</option>
                            <option value="both">两种格式</option>
                        </select>
                        <small class="text-secondary">选择密钥导出格式</small>
                    </div>

                    <div class="form-group hidden" id="optionsGroup">
                        <label class="label">账户信息</label>
                        <div id="accountInfo" class="options-preview" style="max-height: 150px;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                请先上传options.txt文件
                            </div>
                        </div>
                        <button class="btn btn-outline btn-full" id="useOptionsBtn" onclick="useOptionsForEnt()" disabled>
                            <i class="fas fa-arrow-right"></i>
                            用于ENT解密
                        </button>
                    </div>
                </div>
            </div>

    <!-- Key Database Management -->
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-database"></i>
                密钥库管理
            </div>
            <span class="badge badge-info">
                <span id="keyLibraryCount">0</span> 个密钥
            </span>
        </div>
        <div class="card-content">
            <div class="key-management-buttons">
                <button class="btn btn-outline btn-half" onclick="exportKeyDatabase()">
                    <i class="fas fa-download"></i>
                    导出密钥库
                </button>
                <button class="btn btn-outline btn-half" onclick="document.getElementById('importKeyInput').click()">
                    <i class="fas fa-upload"></i>
                    导入密钥库
                </button>
                <input type="file" id="importKeyInput" accept=".json" style="display: none;" onchange="importKeyDatabase(event)">
            </div>
            <div class="key-database-summary" id="keyDatabaseSummary">
                <div class="summary-item">
                    <span class="summary-label">总密钥数</span>
                    <span class="summary-value" id="totalKeysCount">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">最后更新</span>
                    <span class="summary-value" id="lastUpdateTime">从未</span>
                </div>
            </div>
            <div class="key-database-actions">
                <button class="btn btn-danger btn-small" onclick="clearKeyDatabase()">
                    <i class="fas fa-trash"></i>
                    清空密钥库
                </button>
                <button class="btn btn-info btn-small" onclick="viewKeyDatabase()">
                    <i class="fas fa-eye"></i>
                    查看密钥
                </button>
            </div>
        </div>
    </div>

    <!-- Action Area -->
    <div class="action-area">
        <button class="btn btn-primary btn-lg btn-full" id="processBtn" onclick="processFiles()" disabled>
            <i class="fas fa-lock"></i>
            <span id="processBtnText">开始加解密</span>
        </button>
        <button class="btn btn-success btn-lg btn-full hidden" id="downloadBtn" onclick="downloadResult()">
            <i class="fas fa-download"></i>
            下载结果
        </button>
        <button class="btn btn-warning btn-full" onclick="cleanupFiles()">
            <i class="fas fa-trash"></i>
            清理临时文件
        </button>
    </div>
</div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// API 基础URL
const API_BASE = 'https://www.menthamc.club:5000';

let selectedFiles = [];
let extractedFiles = [];
let currentDownloadFilename = null;
let currentMode = 'encrypt'; // 'encrypt', 'decrypt', 'ent', or 'options'
let isProcessingZip = false;
let optionsData = null; // 存储options.txt数据
let entKeys = []; // 存储ENT解析出的密钥
let keyDatabaseCount = 0; // 密钥数据库中的密钥数量

// 密钥库管理
let keyDatabase = {
    keys: {}, // uuid -> key 映射
    metadata: {
        totalKeys: 0,
        lastUpdate: null,
        version: '1.0'
    }
};

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    setupFileUpload();
    checkApiStatus();
    checkMobileDevice();
    updateKeyDatabaseStatus(); // 更新密钥库状态
    switchTab('encrypt'); // 默认加密模式
});

// 检查移动设备
function checkMobileDevice() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.getElementById('mobileWarning').style.display = 'flex';
    }
}

function closeMobileWarning() {
    document.getElementById('mobileWarning').style.display = 'none';
}

// 切换标签页
function switchTab(mode) {
    currentMode = mode;
    
    // 更新标签按钮状态
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-button[onclick="switchTab('${mode}')"]`).classList.add('active');
    
    // 更新内容显示
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`${mode}-tab`).classList.add('active');
    
    // 显示/隐藏设置组
    document.getElementById('customKeyGroup').style.display = 
        mode === 'encrypt' ? 'block' : 'none';
    document.getElementById('decryptSmartGroup').style.display = 
        mode === 'decrypt' ? 'block' : 'none';
    document.getElementById('entOptionsGroup').style.display = 
        mode === 'ent' ? 'block' : 'none';
    document.getElementById('optionsGroup').style.display = 
        mode === 'options' ? 'block' : 'none';
    
    // 更新UI文本
    if (mode === 'encrypt') {
        document.getElementById('processBtnText').textContent = '开始加密';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-lock"></i> 开始加密';
        document.getElementById('customKey').placeholder = '留空将自动生成';
    } else if (mode === 'decrypt') {
        document.getElementById('processBtnText').textContent = '智能解密';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-magic"></i> 智能解密';
        document.getElementById('manualDecryptKey').placeholder = '留空使用智能匹配';
    } else if (mode === 'ent') {
        document.getElementById('processBtnText').textContent = '解析ENT文件';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-key"></i> 解析ENT文件';
    } else if (mode === 'options') {
        document.getElementById('processBtnText').textContent = '解析Options.txt';
        document.getElementById('processBtn').innerHTML = '<i class="fas fa-cog"></i> 解析Options.txt';
    }
    
    // 重置文件选择
    selectedFiles = [];
    extractedFiles = [];
    
    updateProcessButton();
    
    // 只在切换到非Options模式时隐藏结果
    if (mode !== 'options') {
        hideResults();
    }
}

// 更新密钥数据库状态
function updateKeyDatabaseStatus() {
    const dbKeyCountEl = document.getElementById('dbKeyCount');
    const sidebarKeyCountEl = document.getElementById('sidebarKeyCount');
    const dbStatusEl = document.getElementById('dbStatus');
    const keyLibraryCountEl = document.getElementById('keyLibraryCount');
    const totalKeysCountEl = document.getElementById('totalKeysCount');
    const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
    
    const totalKeys = keyDatabase.metadata.totalKeys;
    
    if (dbKeyCountEl) {
        dbKeyCountEl.textContent = totalKeys;
    }
    if (sidebarKeyCountEl) {
        sidebarKeyCountEl.textContent = totalKeys;
    }
    if (dbStatusEl) {
        dbStatusEl.textContent = totalKeys > 0 ? '活跃' : '空';
    }
    if (keyLibraryCountEl) {
        keyLibraryCountEl.textContent = totalKeys;
    }
    if (totalKeysCountEl) {
        totalKeysCountEl.textContent = totalKeys;
    }
    if (lastUpdateTimeEl) {
        if (keyDatabase.metadata.lastUpdate) {
            const updateTime = new Date(keyDatabase.metadata.lastUpdate);
            lastUpdateTimeEl.textContent = updateTime.toLocaleString();
        } else {
            lastUpdateTimeEl.textContent = '从未';
        }
    }
}

// 添加密钥到数据库
function addKeysToDatabase(keys) {
    if (!keys || keys.length === 0) return;
    
    let addedCount = 0;
    keys.forEach(key => {
        const uuid = key.id || key.uuid;
        const contentKey = key.contentKey || key.content_key;
        
        if (uuid && contentKey) {
            // 检查是否已存在
            if (!keyDatabase.keys[uuid]) {
                keyDatabase.keys[uuid] = {
                    uuid: uuid,
                    key: contentKey,
                    addedTime: new Date().toISOString(),
                    source: 'ENT'
                };
                addedCount++;
            }
        }
    });
    
    keyDatabase.metadata.totalKeys = Object.keys(keyDatabase.keys).length;
    keyDatabase.metadata.lastUpdate = new Date().toISOString();
    
    updateKeyDatabaseStatus();
    
    if (addedCount > 0) {
        showToast(`成功添加 ${addedCount} 个新密钥到密钥库`, 'success');
    }
}

// 导出密钥库
function exportKeyDatabase() {
    try {
        if (keyDatabase.metadata.totalKeys === 0) {
            showToast('密钥库为空，无法导出', 'warning');
            return;
        }
        
        const exportData = {
            ...keyDatabase,
            exportTime: new Date().toISOString(),
            exportVersion: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `minecraft_key_database_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(link.href);
        
        showToast(`成功导出 ${keyDatabase.metadata.totalKeys} 个密钥`, 'success');
        
    } catch (error) {
        showToast('导出密钥库失败: ' + error.message, 'error');
    }
}

// 导入密钥库
async function importKeyDatabase(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        const text = await file.text();
        const importData = JSON.parse(text);
        
        // 验证导入数据格式
        if (!importData.keys || !importData.metadata) {
            throw new Error('无效的密钥库文件格式');
        }
        
        // 合并密钥（避免覆盖现有密钥）
        let importedCount = 0;
        let updatedCount = 0;
        
        Object.keys(importData.keys).forEach(uuid => {
            const importKey = importData.keys[uuid];
            if (keyDatabase.keys[uuid]) {
                // 更新现有密钥
                keyDatabase.keys[uuid] = {
                    ...keyDatabase.keys[uuid],
                    ...importKey,
                    updatedTime: new Date().toISOString()
                };
                updatedCount++;
            } else {
                // 添加新密钥
                keyDatabase.keys[uuid] = {
                    ...importKey,
                    importedTime: new Date().toISOString()
                };
                importedCount++;
            }
        });
        
        // 更新元数据
        keyDatabase.metadata.totalKeys = Object.keys(keyDatabase.keys).length;
        keyDatabase.metadata.lastUpdate = new Date().toISOString();
        
        updateKeyDatabaseStatus();
        
        showToast(`导入完成！新增 ${importedCount} 个密钥，更新 ${updatedCount} 个密钥`, 'success');
        
    } catch (error) {
        showToast('导入密钥库失败: ' + error.message, 'error');
    }
    
    // 清空文件输入
    event.target.value = '';
}

// 清空密钥库
function clearKeyDatabase() {
    if (keyDatabase.metadata.totalKeys === 0) {
        showToast('密钥库已经为空', 'info');
        return;
    }
    
    if (confirm(`确定要清空密钥库吗？这将删除所有 ${keyDatabase.metadata.totalKeys} 个密钥，且无法恢复！`)) {
        keyDatabase.keys = {};
        keyDatabase.metadata.totalKeys = 0;
        keyDatabase.metadata.lastUpdate = new Date().toISOString();
        
        updateKeyDatabaseStatus();
        showToast('密钥库已清空', 'info');
    }
}

// 查看密钥库
function viewKeyDatabase() {
    if (keyDatabase.metadata.totalKeys === 0) {
        showToast('密钥库为空', 'info');
        return;
    }
    
    // 创建模态窗口显示密钥库内容
    const modal = document.createElement('div');
    modal.className = 'key-database-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: var(--bg);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    `;
    
    let keysHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="margin: 0; color: var(--text);">
                <i class="fas fa-database"></i>
                密钥库内容 (${keyDatabase.metadata.totalKeys} 个密钥)
            </h2>
            <button onclick="this.closest('.key-database-modal').remove()" style="background: var(--error); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); cursor: pointer;">
                <i class="fas fa-times"></i>
                关闭
            </button>
        </div>
        <div style="display: grid; gap: 1rem;">
    `;
    
    Object.keys(keyDatabase.keys).forEach(uuid => {
        const keyData = keyDatabase.keys[uuid];
        keysHTML += `
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                <div style="font-family: monospace; font-weight: bold; color: var(--text); margin-bottom: 0.5rem;">
                    UUID: ${uuid}
                </div>
                <div style="font-family: monospace; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    密钥: ${keyData.key}
                </div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                    来源: ${keyData.source || '未知'} | 
                    添加时间: ${keyData.addedTime ? new Date(keyData.addedTime).toLocaleString() : '未知'}
                    <button onclick="copyToClipboard('${keyData.key}', this)" style="margin-left: 1rem; background: var(--info); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-copy"></i> 复制
                    </button>
                </div>
            </div>
        `;
    });
    
    keysHTML += '</div>';
    modalContent.innerHTML = keysHTML;
    modal.appendChild(modalContent);
    
    // 点击背景关闭模态窗口
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

// 处理解密模式下的ENT文件
async function processDecryptEntFile(file) {
    try {
        showToast('正在解析ENT文件并保存密钥...', 'info');
        
        // 获取Minecraft ID
        const minecraftId = document.getElementById('decryptMinecraftId').value.trim();
        
        // 创建FormData
        const formData = new FormData();
        formData.append('ent_file', file);
        
        if (minecraftId) {
            formData.append('minecraft_id', minecraftId);
        }
        
        formData.append('output_format', 'json');

        // 发送请求解析ENT
        const response = await fetch(`${API_BASE}/api/decrypt-ent`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // 保存密钥数据
            entKeys = data.keys || [];
            
            // 添加密钥到本地数据库
            addKeysToDatabase(entKeys);
            
            showToast(`ENT文件解析成功！已向密钥库添加密钥`, 'success');
        } else {
            throw new Error(data.error || 'ENT解析失败');
        }
        
    } catch (error) {
        showToast('ENT文件解析失败: ' + error.message, 'error');
    }
}

// 文件上传设置
function setupFileUpload() {
    // 加密模式的文件上传
    setupUploadZone('encryptUploadZone', ['encryptFolderInput', 'encryptFileInput']);
    // 解密模式的文件上传
    setupUploadZone('decryptUploadZone', ['decryptFolderInput', 'decryptFileInput']);
    // 解密模式的ENT文件上传
    setupUploadZone('decryptEntUploadZone', ['decryptEntInput']);
    // ENT模式的文件上传
    setupUploadZone('entUploadZone', ['entFileInput']);
    // Options模式的文件上传
    setupUploadZone('optionsUploadZone', ['optionsFileInput']);
}

function setupUploadZone(zoneId, inputIds) {
    const uploadZone = document.getElementById(zoneId);
    const inputs = inputIds.map(id => document.getElementById(id));

    // 文件选择事件
    inputs.forEach(input => {
        input.addEventListener('change', handleFileSelect);
    });

    // 拖拽功能
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            handleDroppedFiles(files);
        }
    });
}

// 处理文件选择
async function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    
    // 检查是否是解密模式的ENT文件上传
    if (event.target.id === 'decryptEntInput') {
        if (files.length > 0) {
            await processDecryptEntFile(files[0]);
        }
        return;
    }
    
    if (currentMode === 'ent') {
        // ENT模式只处理单个文件
        if (files.length > 0) {
            selectedFiles = [files[0]];
            displayEntFile(files[0]);
            updateProcessButton();
        }
    } else if (currentMode === 'options') {
        // Options模式只处理单个文件
        if (files.length > 0) {
            selectedFiles = [files[0]];
            await processOptionsFile(files[0]);
            updateProcessButton();
        }
    } else {
        await processSelectedFiles(files);
    }
}

// 处理拖拽文件
async function handleDroppedFiles(files) {
    if (currentMode === 'ent') {
        // ENT模式只处理单个文件
        const entFile = files.find(file => file.name.toLowerCase().endsWith('.ent'));
        if (entFile) {
            selectedFiles = [entFile];
            displayEntFile(entFile);
            updateProcessButton();
        } else {
            showToast('请选择.ent文件', 'error');
        }
    } else if (currentMode === 'options') {
        // Options模式只处理单个文件
        const txtFile = files.find(file => 
            file.name.toLowerCase().endsWith('.txt') && 
            file.name.toLowerCase().includes('options')
        );
        if (txtFile) {
            selectedFiles = [txtFile];
            await processOptionsFile(txtFile);
            updateProcessButton();
        } else {
            showToast('请选择options.txt文件', 'error');
        }
    } else {
        await processSelectedFiles(files);
    }
}

// 处理Options.txt文件
async function processOptionsFile(file) {
    try {
        // 先使用后端API解析
        const formData = new FormData();
        formData.append('options_file', file);
        
        const response = await fetch(`${API_BASE}/api/parse-options`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            optionsData = data.options;
            const keyData = {
                minecraftId: data.minecraft_id,
                titleAccountId: data.title_account_id
            };
            
            displayOptionsInfo(keyData, data.total_options);
            
            // 如果有关键信息，启用"传入ENT解密"按钮
            if (keyData.minecraftId || keyData.titleAccountId) {
                document.getElementById('useOptionsBtn').disabled = false;
            }
            
            showToast('Options.txt文件解析成功', 'success');
        } else {
            throw new Error(data.error || '解析失败');
        }
        
    } catch (error) {
        showToast('解析Options.txt文件失败: ' + error.message, 'error');
        
        // 如果API失败，回退到本地解析
        try {
            const text = await file.text();
            const lines = text.split('\n');
            
            optionsData = {};
            const keyData = {};
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine && trimmedLine.includes(':')) {
                    const [key, value] = trimmedLine.split(':', 2);
                    const cleanKey = key.trim();
                    const cleanValue = value.trim();
                    
                    optionsData[cleanKey] = cleanValue;
                    
                    // 提取关键信息
                    if (cleanKey === 'last_minecraft_id') {
                        keyData.minecraftId = cleanValue.toUpperCase();
                    } else if (cleanKey === 'last_title_account_id') {
                        keyData.titleAccountId = cleanValue.toUpperCase();
                    }
                }
            });
            
            displayOptionsInfo(keyData, Object.keys(optionsData).length);
            
            // 如果有关键信息，启用"传入ENT解密"按钮
            if (keyData.minecraftId || keyData.titleAccountId) {
                document.getElementById('useOptionsBtn').disabled = false;
            }
            
            showToast('Options.txt文件本地解析成功', 'success');
            
        } catch (localError) {
            showToast('Options.txt文件解析完全失败: ' + localError.message, 'error');
        }
    }
}

// 显示Options信息
function displayOptionsInfo(keyData, totalKeys) {
    const optionsInfo = document.getElementById('optionsInfo');
    const optionsDetails = document.getElementById('optionsDetails');
    const accountInfo = document.getElementById('accountInfo');
    
    let detailsHTML = `
        <div class="options-key-value">
            <span class="options-key">配置项总数</span>
            <span class="options-value">${totalKeys}</span>
        </div>
    `;
    
    // 优先显示 Title Account ID
    if (keyData.titleAccountId) {
        detailsHTML += `
            <div class="options-key-value">
                <span class="options-key">Title Account ID</span>
                <span class="options-value">${keyData.titleAccountId}</span>
            </div>
        `;
    }
    
    if (keyData.minecraftId) {
        detailsHTML += `
            <div class="options-key-value">
                <span class="options-key">Minecraft ID</span>
                <span class="options-value">${keyData.minecraftId}</span>
            </div>
        `;
    }
    
    optionsDetails.innerHTML = detailsHTML;
    
    // 更新侧边栏账户信息，优先显示 Title Account ID
    let accountHTML = '';
    if (keyData.titleAccountId) {
        accountHTML += `<div><strong>Title Account ID:</strong><br><code>${keyData.titleAccountId}</code></div>`;
    }
    if (keyData.minecraftId) {
        accountHTML += `<div style="margin-top: 0.5rem;"><strong>Minecraft ID:</strong><br><code>${keyData.minecraftId}</code></div>`;
    }
    
    if (!accountHTML) {
        accountHTML = '<div style="text-align: center; color: var(--text-secondary);">未找到关键账户信息</div>';
    }
    
    accountInfo.innerHTML = accountHTML;
    optionsInfo.style.display = 'block';
}

// 使用Options数据进行ENT解密
function useOptionsForEnt() {
    if (!optionsData) {
        showToast('请先上传options.txt文件', 'error');
        return;
    }
    
    // 优先使用 Title Account ID，其次使用 Minecraft ID
    const titleAccountId = optionsData['last_title_account_id'];
    const minecraftId = optionsData['last_minecraft_id'];
    
    const accountId = titleAccountId || minecraftId;
    
    if (!accountId) {
        showToast('Options.txt中未找到有效的账户ID', 'error');
        return;
    }
    
    // 切换到ENT标签页
    switchTab('ent');
    
    // 填入账户ID
    document.getElementById('minecraftId').value = accountId.toUpperCase();
    
    const idType = titleAccountId ? 'Title Account ID' : 'Minecraft ID';
    showToast(`${idType}已自动填入ENT解密页面`, 'success');
}

// 显示ENT文件信息
function displayEntFile(file) {
    const fileListSection = document.getElementById('fileListSection');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');

    fileList.innerHTML = '';
    fileCount.textContent = 1;

    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
        <div class="file-info">
            <div class="file-icon" style="background: var(--info);">
                <i class="fas fa-file-code"></i>
            </div>
            <div class="file-details">
                <h4>${file.name}</h4>
                <p>${formatFileSize(file.size)} • ENT授权文件</p>
            </div>
        </div>
    `;
    fileList.appendChild(fileItem);

    fileListSection.style.display = 'block';
}

// 处理选择的文件（对于encrypt/decrypt模式）
async function processSelectedFiles(files) {
    // 检查是否有ZIP文件
    const zipFiles = files.filter(file => 
        file.name.toLowerCase().endsWith('.zip') || 
        file.name.toLowerCase().endsWith('.mcpack')
    );
    
    if (zipFiles.length > 0) {
        // 如果有ZIP文件，先解压
        await handleZipFiles(zipFiles, files);
    } else {
        // 没有ZIP文件，直接处理
        selectedFiles = files;
        displayFileList(files);
        updateProcessButton();
    }
}

// 处理ZIP文件
async function handleZipFiles(zipFiles, allFiles) {
    if (isProcessingZip) {
        showToast('正在处理ZIP文件，请稍候...', 'warning');
        return;
    }
    
    isProcessingZip = true;
    showToast('正在解压ZIP文件...', 'info');
    
    try {
        extractedFiles = [];
        const nonZipFiles = allFiles.filter(file => 
            !file.name.toLowerCase().endsWith('.zip') && 
            !file.name.toLowerCase().endsWith('.mcpack')
        );
        
        // 添加非ZIP文件
        extractedFiles.push(...nonZipFiles);
        
        // 处理每个ZIP文件
        for (const zipFile of zipFiles) {
            const extractedFromZip = await extractZipFile(zipFile);
            extractedFiles.push(...extractedFromZip);
        }
        
        // 显示解压结果
        selectedFiles = extractedFiles;
        displayFileList(extractedFiles);
        updateProcessButton();
        
        showToast(`成功解压 ${zipFiles.length} 个ZIP文件，共提取 ${extractedFiles.length} 个文件`, 'success');
        
    } catch (error) {
        console.error('ZIP文件处理失败:', error);
        showToast('ZIP文件解压失败: ' + error.message, 'error');
        
        // 如果解压失败，回退到原始文件
        selectedFiles = allFiles;
        displayFileList(allFiles);
        updateProcessButton();
    } finally {
        isProcessingZip = false;
    }
}

// 解压单个ZIP文件
async function extractZipFile(zipFile) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const zip = new JSZip();
                const zipData = await zip.loadAsync(e.target.result);
                const extractedFiles = [];
                
                // 遍历ZIP中的所有文件
                for (const [fileName, fileObj] of Object.entries(zipData.files)) {
                    // 跳过目录
                    if (fileObj.dir) continue;
                    
                    // 获取文件内容
                    const fileContent = await fileObj.async('blob');
                    
                    // 创建新的File对象
                    const extractedFile = new File([fileContent], fileName, {
                        type: getFileType(fileName),
                        lastModified: fileObj.date ? fileObj.date.getTime() : Date.now()
                    });
                    
                    // 添加原始ZIP文件信息
                    extractedFile.sourceZip = zipFile.name;
                    extractedFile.originalPath = fileName;
                    
                    extractedFiles.push(extractedFile);
                }
                
                resolve(extractedFiles);
            } catch (error) {
                reject(new Error(`解压 ${zipFile.name} 失败: ${error.message}`));
            }
        };
        
        reader.onerror = () => reject(new Error(`读取 ${zipFile.name} 失败`));
        reader.readAsArrayBuffer(zipFile);
    });
}

// 根据文件名判断MIME类型
function getFileType(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const typeMap = {
        'json': 'application/json',
        'png': 'image/png',
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'gif': 'image/gif',
        'txt': 'text/plain',
        'js': 'text/javascript',
        'css': 'text/css',
        'html': 'text/html',
        'wav': 'audio/wav',
        'ogg': 'audio/ogg',
        'mcmeta': 'application/json',
        'mcfunction': 'text/plain',
        'ent': 'text/plain'
    };
    
    return typeMap[ext] || 'application/octet-stream';
}

// 修改显示文件列表函数，显示解压信息
function displayFileList(files) {
    const fileListSection = document.getElementById('fileListSection');
    const fileList = document.getElementById('fileList');
    const fileCount = document.getElementById('fileCount');

    fileList.innerHTML = '';
    fileCount.textContent = files.length;

    // 统计ZIP来源
    const zipSources = {};
    const regularFiles = [];
    
    files.forEach(file => {
        if (file.sourceZip) {
            if (!zipSources[file.sourceZip]) {
                zipSources[file.sourceZip] = [];
            }
            zipSources[file.sourceZip].push(file);
        } else {
            regularFiles.push(file);
        }
    });

    let displayCount = 0;
    const maxDisplay = 20;

    // 显示ZIP来源的文件
    for (const [zipName, zipFiles] of Object.entries(zipSources)) {
        if (displayCount >= maxDisplay) break;
        
        // ZIP文件组标题
        const zipGroupItem = document.createElement('div');
        zipGroupItem.className = 'file-item';
        zipGroupItem.style.backgroundColor = 'var(--bg)';
        zipGroupItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon" style="background: var(--info);">
                    <i class="fas fa-file-archive"></i>
                </div>
                <div class="file-details">
                    <h4>📦 ${zipName}</h4>
                    <p>包含 ${zipFiles.length} 个文件</p>
                </div>
            </div>
        `;
        fileList.appendChild(zipGroupItem);
        displayCount++;

        // 显示ZIP中的文件（最多显示5个）
        const filesToShow = zipFiles.slice(0, 5);
        filesToShow.forEach(file => {
            if (displayCount >= maxDisplay) return;
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.style.marginLeft = '20px';
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas ${getFileIcon(file.name)}"></i>
                    </div>
                    <div class="file-details">
                        <h4>${file.originalPath || file.name}</h4>
                        <p>${formatFileSize(file.size)} • 来自ZIP</p>
                    </div>
                </div>
            `;
            fileList.appendChild(fileItem);
            displayCount++;
        });

        // 如果ZIP中文件太多，显示省略信息
        if (zipFiles.length > 5) {
            const moreItem = document.createElement('div');
            moreItem.className = 'file-item';
            moreItem.style.marginLeft = '20px';
            moreItem.style.opacity = '0.7';
            moreItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="file-details">
                        <h4>还有 ${zipFiles.length - 5} 个文件...</h4>
                        <p>来自 ${zipName}</p>
                    </div>
                </div>
            `;
            fileList.appendChild(moreItem);
            displayCount++;
        }
    }

    // 显示常规文件
    regularFiles.slice(0, maxDisplay - displayCount).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">
                    <i class="fas ${getFileIcon(file.name)}"></i>
                </div>
                <div class="file-details">
                    <h4>${file.name}</h4>
                    <p>${formatFileSize(file.size)}</p>
                </div>
            </div>
        `;
        fileList.appendChild(fileItem);
        displayCount++;
    });

    // 如果还有更多文件未显示
    const remainingFiles = files.length - displayCount;
    if (remainingFiles > 0) {
        const moreItem = document.createElement('div');
        moreItem.className = 'file-item';
        moreItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">
                    <i class="fas fa-ellipsis-h"></i>
                </div>
                <div class="file-details">
                    <h4>还有 ${remainingFiles} 个文件...</h4>
                    <p>点击查看全部</p>
                </div>
            </div>
        `;
        fileList.appendChild(moreItem);
    }

    fileListSection.style.display = files.length > 0 ? 'block' : 'none';
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'json': return 'fa-file-code';
        case 'png': case 'jpg': case 'jpeg': return 'fa-image';
        case 'zip': case 'mcpack': case 'mcworld': case 'mctemplate': return 'fa-file-archive';
        case 'ent': return 'fa-file-code';
        case 'txt': return 'fa-file-text';
        default: return 'fa-file';
    }
}

function updateProcessButton() {
    const processBtn = document.getElementById('processBtn');
    
    if (currentMode === 'options') {
        // Options模式：如果已有数据，显示为已解析状态
        if (optionsData) {
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-check"></i> 已解析Options.txt';
        } else {
            processBtn.disabled = selectedFiles.length === 0;
        }
    } else {
        processBtn.disabled = selectedFiles.length === 0;
    }
}

function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('entResultsSection').style.display = 'none';
    document.getElementById('downloadBtn').classList.add('hidden');
    document.getElementById('fileListSection').style.display = 'none';
    currentDownloadFilename = null;
}

// 检查API状态
async function checkApiStatus() {
    const statusElement = document.getElementById('api-status');
    
    try {
        const response = await fetch(`${API_BASE}/api/health`);
        const data = await response.json();
        
        if (data.status === 'ok') {
            statusElement.className = 'status-indicator status-online';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> 服务在线';
        } else {
            throw new Error('API返回错误状态');
        }
    } catch (error) {
        statusElement.className = 'status-indicator status-offline';
        statusElement.innerHTML = '<i class="fas fa-circle"></i> 服务离线';
        console.error('API状态检查失败:', error);
    }
}

// 生成密钥
async function generateKey() {
    const customKeyInput = document.getElementById('customKey');
    
    try {
        const response = await fetch(`${API_BASE}/api/generate-key`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            customKeyInput.value = data.key;
            showToast('密钥生成成功！', 'success');
        } else {
            throw new Error(data.error || '生成密钥失败');
        }
    } catch (error) {
        showToast('生成密钥失败: ' + error.message, 'error');
        console.error('生成密钥失败:', error);
    }
}

// 重新打包为ZIP的辅助函数
async function repackAsZip(files, zipName = 'extracted_files.zip') {
    const zip = new JSZip();
    
    for (const file of files) {
        const fileName = file.originalPath || file.webkitRelativePath || file.name;
        zip.file(fileName, file);
    }
    
    const zipBlob = await zip.generateAsync({type: 'blob'});
    return new File([zipBlob], zipName, {type: 'application/zip'});
}

// 处理文件（加密、解密、ENT解析或Options解析）
async function processFiles() {
    if (selectedFiles.length === 0) {
        showToast('请先选择文件', 'error');
        return;
    }

    if (currentMode === 'ent') {
        return processEntFile();
    } else if (currentMode === 'options') {
        return processOptionsOnly();
    }

    const customKey = currentMode === 'decrypt' ? 
        document.getElementById('manualDecryptKey').value : 
        document.getElementById('customKey').value;
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const processBtn = document.getElementById('processBtn');
    const resultsSection = document.getElementById('resultsSection');

    // 重置UI
    resultsSection.style.display = 'none';
    progressSection.style.display = 'block';
    processBtn.disabled = true;
    
    const actionText = currentMode === 'encrypt' ? '加密' : '智能解密';
    processBtn.innerHTML = `<span class="spinner"></span> ${actionText}中...`;

    try {
        // 创建FormData
        const formData = new FormData();
        
        // 如果有解压的文件，需要重新打包为ZIP
        if (selectedFiles.some(file => file.sourceZip)) {
            updateProgress(10, '正在重新打包文件...');
            const repackedZip = await repackAsZip(selectedFiles, 'processed_files.zip');
            formData.append('files', repackedZip);
        } else {
            // 添加原始文件
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
        }
        
        // 添加自定义密钥
        if (customKey.trim()) {
            formData.append('custom_key', customKey.trim());
        }

        // 更新进度
        updateProgress(30, `正在上传文件...`);

        // 选择API端点
        const endpoint = currentMode === 'encrypt' ? '/api/encrypt' : '/api/decrypt';

        // 发送请求
        const response = await fetch(`${API_BASE}${endpoint}`, {
            method: 'POST',
            body: formData
        });

        updateProgress(70, `正在${actionText}文件...`);

        const data = await response.json();

        if (data.success) {
            updateProgress(100, `${actionText}完成！`);
            
            setTimeout(() => {
                displayProcessResult(data);
                progressSection.style.display = 'none';
            }, 1000);
        } else {
            throw new Error(data.error || `${actionText}失败`);
        }

    } catch (error) {
        console.error(`${actionText}失败:`, error);
        showToast(`${actionText}失败: ` + error.message, 'error');
        progressSection.style.display = 'none';
    } finally {
        // 恢复按钮
        processBtn.disabled = false;
        const icon = currentMode === 'encrypt' ? 'fa-lock' : 'fa-magic';
        const text = currentMode === 'encrypt' ? '开始加密' : '智能解密';
        processBtn.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }
}

// 处理Options.txt文件（仅解析）
async function processOptionsOnly() {
    if (optionsData) {
        showToast('Options.txt文件已解析完成', 'info');
        return;
    }
    
    const file = selectedFiles[0];
    await processOptionsFile(file);
}

// 处理ENT文件
async function processEntFile() {
    const entFile = selectedFiles[0];
    const minecraftId = document.getElementById('minecraftId').value.trim();
    const outputFormat = document.getElementById('entOutputFormat').value;
    
    const progressSection = document.getElementById('progressSection');
    const processBtn = document.getElementById('processBtn');

    // 重置UI
    progressSection.style.display = 'block';
    processBtn.disabled = true;
    processBtn.innerHTML = `<span class="spinner"></span> 解析中...`;

    try {
        // 创建FormData
        const formData = new FormData();
        formData.append('ent_file', entFile);
        
        if (minecraftId) {
            formData.append('minecraft_id', minecraftId);
        }
        
        formData.append('output_format', outputFormat);

        updateProgress(30, '正在上传ENT文件...');

        // 发送请求
        const response = await fetch(`${API_BASE}/api/decrypt-ent`, {
            method: 'POST',
            body: formData
        });

        updateProgress(70, '正在解析ENT文件...');

        const data = await response.json();

        if (data.success) {
            updateProgress(100, 'ENT解析完成！');
            
            // 保存密钥数据并更新数据库
            entKeys = data.keys || [];
            addKeysToDatabase(entKeys);
            
            setTimeout(() => {
                displayEntResult(data);
                progressSection.style.display = 'none';
            }, 1000);
        } else {
            throw new Error(data.error || 'ENT解析失败');
        }

    } catch (error) {
        console.error('ENT解析失败:', error);
        showToast('ENT解析失败: ' + error.message, 'error');
        progressSection.style.display = 'none';
    } finally {
        // 恢复按钮
        processBtn.disabled = false;
        processBtn.innerHTML = '<i class="fas fa-key"></i> 解析ENT文件';
    }
}

// 显示ENT解析结果
function displayEntResult(data) {
    const entResultsSection = document.getElementById('entResultsSection');
    const fileListSection = document.getElementById('fileListSection');
    const entResultInfo = document.getElementById('entResultInfo');
    const keyList = document.getElementById('keyList');
    const keyCount = document.getElementById('keyCount');
    const downloadBtn = document.getElementById('downloadBtn');

    // 隐藏文件列表窗口
    fileListSection.style.display = 'none';

    // 更新密钥数量
    keyCount.textContent = data.keys ? data.keys.length : 0;

    // 构建ENT文件信息
    let infoHTML = `
        <div class="pack-info-item">
            <span class="pack-info-label">文件名</span>
            <span class="pack-info-value">${selectedFiles[0].name}</span>
        </div>
        <div class="pack-info-item">
            <span class="pack-info-label">文件大小</span>
            <span class="pack-info-value">${formatFileSize(selectedFiles[0].size)}</span>
        </div>
        <div class="pack-info-item">
            <span class="pack-info-label">文件类型</span>
            <span class="pack-info-value">${data.file_type || '未知'}</span>
        </div>
        <div class="pack-info-item">
            <span class="pack-info-label">保存密钥数</span>
            <span class="pack-info-value">${data.keys ? data.keys.length : 0}</span>
        </div>
    `;

    if (data.user_info) {
        infoHTML += `
            <div class="pack-info-item">
                <span class="pack-info-label">用户ID</span>
                <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${data.user_info.user_id || '未知'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">设备ID</span>
                <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${data.user_info.device_id || '未知'}</span>
            </div>
        `;
    }

    entResultInfo.innerHTML = infoHTML;

    // 显示密钥列表
    keyList.innerHTML = '';
    
    if (data.keys && data.keys.length > 0) {
        data.keys.forEach((key, index) => {
            const keyItem = document.createElement('div');
            keyItem.className = 'key-item';
            keyItem.innerHTML = `
                <div class="key-info">
                    <div class="key-uuid">${key.id || key.uuid || `密钥 ${index + 1}`}</div>
                    <div class="key-value">${key.contentKey || key.content_key || '未知密钥'}</div>
                </div>
                <button class="copy-btn" onclick="copyToClipboard('${key.contentKey || key.content_key || ''}', this)">
                    <i class="fas fa-copy"></i>
                    复制
                </button>
            `;
            keyList.appendChild(keyItem);
        });
    } else {
        keyList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">未找到任何密钥</div>';
    }

    // 设置下载功能
    if (data.download_filename) {
        currentDownloadFilename = data.download_filename;
        downloadBtn.classList.remove('hidden');
    }

    entResultsSection.style.display = 'block';
    showToast(`ENT文件解析成功！已保存 ${data.keys ? data.keys.length : 0} 个密钥到数据库`, 'success');
}

// 复制到剪贴板
async function copyToClipboard(text, button) {
    try {
        await navigator.clipboard.writeText(text);
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> 已复制';
        button.style.background = 'var(--success)';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = 'var(--info)';
        }, 2000);
        
        showToast('密钥已复制到剪贴板', 'success');
    } catch (error) {
        showToast('复制失败: ' + error.message, 'error');
    }
}

// 更新进度条
function updateProgress(percent, text) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    progressFill.style.width = percent + '%';
    progressText.textContent = text;
}

// 显示处理结果
function displayProcessResult(data) {
    const resultsSection = document.getElementById('resultsSection');
    const fileListSection = document.getElementById('fileListSection');
    const processedFiles = document.getElementById('processedFiles');
    const totalFiles = document.getElementById('totalFiles');
    const packageName = document.getElementById('packageName');
    const operationKey = document.getElementById('operationKey');
    const packDetailsInfo = document.getElementById('packDetailsInfo');
    const downloadBtn = document.getElementById('downloadBtn');
    const resultTitle = document.getElementById('resultTitle');
    const processedLabel = document.getElementById('processedLabel');
    const keyMatchingStatus = document.getElementById('keyMatchingStatus');
    const keyMatchingText = document.getElementById('keyMatchingText');
    const keyLabel = document.getElementById('keyLabel');

    // 隐藏文件列表窗口
    fileListSection.style.display = 'none';

    // 更新标题和标签
    if (currentMode === 'encrypt') {
        resultTitle.textContent = '加密结果';
        processedLabel.textContent = '加密文件数';
        processedFiles.textContent = data.encrypted_files || 0;
        keyLabel.textContent = '生成密钥';
        keyMatchingStatus.style.display = 'none';
    } else {
        resultTitle.textContent = '智能解密结果';
        processedLabel.textContent = '解密文件数';
        processedFiles.textContent = data.decrypted_files || 0;
        keyLabel.textContent = '匹配密钥';
        
        // 显示密钥匹配状态
        keyMatchingStatus.style.display = 'flex';
        if (data.pack_uuid && data.used_key) {
            keyMatchingText.textContent = '智能匹配成功';
            keyMatchingStatus.style.color = 'var(--success)';
        } else {
            keyMatchingText.textContent = '使用默认密钥';
            keyMatchingStatus.style.color = 'var(--warning)';
        }
    }

    // 更新统计数据
    totalFiles.textContent = data.total_files || 0;
    
    if (data.pack_info && data.pack_info.name) {
        packageName.textContent = data.pack_info.name.substring(0, 10) + (data.pack_info.name.length > 10 ? '...' : '');
        packageName.title = data.pack_info.name;
    } else {
        packageName.textContent = '未知';
    }
    
    const keyValue = data.content_key || data.used_key || 's5s5ejuDru4uchuF2drUFuthaspAbepE';
    operationKey.textContent = keyValue.substring(0, 8) + '...';
    operationKey.title = keyValue;

    // 构建详细信息
    let detailsHTML = '';
    
    if (data.pack_info) {
        const info = data.pack_info;
        detailsHTML += `
            <div class="pack-info-item">
                <span class="pack-info-label">包名称</span>
                <span class="pack-info-value">${info.name || '未知'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">描述</span>
                <span class="pack-info-value">${info.description || '无'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">版本</span>
                <span class="pack-info-value">${info.version || '0.0.0'}</span>
            </div>
            <div class="pack-info-item">
                <span class="pack-info-label">UUID</span>
                <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${info.uuid || '未知'}</span>
            </div>
        `;
    }
    
    detailsHTML += `
        <div class="pack-info-item">
            <span class="pack-info-label">${currentMode === 'encrypt' ? '生成密钥' : '使用密钥'}</span>
            <span class="pack-info-value" style="font-family: monospace; word-break: break-all;">${keyValue}</span>
        </div>
    `;

    // 如果是解密模式，显示密钥匹配详情
    if (currentMode === 'decrypt') {
        detailsHTML += `
            <div class="pack-info-item">
                <span class="pack-info-label">密钥来源</span>
                <span class="pack-info-value">${data.pack_uuid ? 'UUID智能匹配' : '默认密钥'}</span>
            </div>
        `;
    }

    packDetailsInfo.innerHTML = detailsHTML;

    // 设置下载功能
    if (data.download_filename) {
        currentDownloadFilename = data.download_filename;
        downloadBtn.classList.remove('hidden');
    }

    resultsSection.style.display = 'block';
    const actionText = currentMode === 'encrypt' ? '加密' : '智能解密';
    showToast(`包${actionText}成功！`, 'success');
}

// 下载结果
function downloadResult() {
    if (currentDownloadFilename) {
        downloadFile(currentDownloadFilename);
    } else {
        showToast('没有可下载的文件', 'error');
    }
}

// 下载文件
async function downloadFile(filename) {
    try {
        const response = await fetch(`${API_BASE}/api/download/${filename}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('文件下载开始', 'success');
        } else {
            throw new Error('下载失败');
        }
    } catch (error) {
        showToast('下载失败: ' + error.message, 'error');
        console.error('下载失败:', error);
    }
}

// 清理文件
async function cleanupFiles() {
    try {
        const response = await fetch(`${API_BASE}/api/cleanup`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('临时文件清理完成', 'success');
        } else {
            throw new Error(data.error || '清理失败');
        }
    } catch (error) {
        showToast('清理失败: ' + error.message, 'error');
        console.error('清理失败:', error);
    }
}

// 显示Toast通知
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    let icon = 'fa-info-circle';
    if (type === 'success') icon = 'fa-check-circle';
    else if (type === 'error') icon = 'fa-exclamation-triangle';
    else if (type === 'warning') icon = 'fa-exclamation-triangle';
    
    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        ${message}
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>

<style>
/* 添加一些新的样式 */
.ent-workflow-info {
    --info-bg: rgba(59, 130, 246, 0.1);
}

.workflow-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.workflow-step {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.step-number {
    background: var(--info);
    color: white;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.step-content strong {
    color: var(--text);
    display: block;
    margin-bottom: 0.25rem;
}

.step-content p {
    margin: 0;
    color: var(--text-secondary);
}

.key-database-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 0.5rem;
}

.status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.status-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.status-value {
    font-weight: bold;
    color: var(--text);
}

.smart-decrypt-info {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
}

.priority-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.priority-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.priority-number {
    background: var(--info);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

.priority-text {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.key-library-status {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.status-header {
    background: var(--info);
    color: white;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    font-weight: bold;
}

.status-content {
    padding: 0.75rem;
}

.status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.status-row:last-child {
    margin-bottom: 0;
}

.status-row span:first-child {
    color: var(--text-secondary);
}

.status-row span:last-child {
    color: var(--text);
    font-weight: bold;
}

.key-matching-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--success);
    font-size: 0.9rem;
}

.database-save-notice {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--success);
    border-radius: var(--radius);
    padding: 1rem;
}

.database-save-notice h4 {
    color: var(--success);
    margin-bottom: 0.5rem;
}

.database-save-notice p {
    color: var(--success);
    margin: 0;
}
</style>
</body>
</html>
